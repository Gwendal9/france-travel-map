<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Carte de France Interactive</title>
    <!-- Updated: 2026-01-22 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Map styling - clean and modern */
        .map-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
        }
        
        .department-path {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            stroke-width: 2;
        }

        .department-path:hover {
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.25)) brightness(1.15);
            stroke-width: 3;
        }

        .department-path:active {
            transform: scale(0.98);
        }
        
        /* City markers with glow */
        .city-marker {
            filter: drop-shadow(0 0 3px rgba(231, 76, 60, 0.6));
            cursor: pointer;
        }
        
        /* Rating bar */
        .rating-bar {
            cursor: pointer;
        }

        .rating-bar:hover {
            transform: scaleY(1.05);
        }

        /* Department detail overlay - simplified */
        .department-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .department-map-full {
            width: 98%;
            height: 98%;
            max-width: 1800px;
            max-height: 1000px;
            background: white;
            border-radius: 2rem;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .city-label {
            font-size: 14px;
            font-weight: 600;
            fill: #1f2937;
            text-shadow: 0 0 3px white, 0 0 6px white;
            pointer-events: none;
        }

        .department-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.2s ease;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const GEOJSON_URL = 'https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson';

        // Real GPS coordinates for major cities [longitude, latitude]
        const CITY_COORDINATES = {
          // Auvergne-Rhône-Alpes
          'Bourg-en-Bresse': [5.2281, 46.2056],
          'Oyonnax': [5.6556, 46.2564],
          'Ambérieu-en-Bugey': [5.3594, 45.9606],
          'Belley': [5.6889, 45.7594],
          'Miribel': [4.9544, 45.8233],
          'Ferney-Voltaire': [6.1086, 46.2558],
          'Gex': [6.0572, 46.3328],
          'Divonne-les-Bains': [6.1431, 46.3561],
          'Trévoux': [4.7731, 45.9403],
          'Nantua': [5.6089, 46.1522],
          'Saint-Quentin': [3.2875, 49.8486],
          'Soissons': [3.3236, 49.3817],
          'Château-Thierry': [3.4033, 49.0467],
          'Tergnier': [3.2961, 49.6558],
          'Chauny': [3.2178, 49.6156],
          'Hirson': [4.0831, 49.9211],
          'Villers-Cotterêts': [3.0894, 49.2542],
          'Bohain-en-Vermandois': [3.4633, 49.9892],
          'Vervins': [3.9067, 49.8356],
          'Moulins': [3.3333, 46.5667],
          'Vichy': [3.4267, 46.1278],
          'Montluçon': [2.6033, 46.3408],
          'Yzeure': [3.3567, 46.5653],
          'Cusset': [3.4531, 46.1325],
          'Domérat': [2.5411, 46.3625],
          'Bellerive-sur-Allier': [3.4039, 46.1158],
          'Commentry': [2.7428, 46.2892],
          'Désertines': [2.6214, 46.3575],
          'Gannat': [3.1978, 46.1006],
          'Manosque': [5.7867, 43.8306],
          'Sisteron': [5.9450, 44.1944],
          'Barcelonnette': [6.6542, 44.3856],
          'Castellane': [6.5139, 43.8472],
          'Embrun': [6.4956, 44.5656],
          'L\'Argentière-la-Bessée': [6.5550, 44.7850],
          'Tallard': [6.0531, 44.4628],
          'Annonay': [4.6700, 45.2400],
          'Aubenas': [4.3900, 44.6200],
          'Tournon-sur-Rhône': [4.8333, 45.0667],
          'Guilherand-Granges': [4.8733, 44.9333],
          'Sedan': [4.9394, 49.7011],
          'Rethel': [4.3644, 49.5111],
          'Givet': [4.8261, 50.1386],
          'Revin': [4.6383, 49.9386],
          'Pamiers': [1.6108, 43.1156],
          'Saint-Girons': [1.1450, 42.9833],
          'Lavelanet': [1.8447, 42.9328],
          'Tarascon-sur-Ariège': [1.6094, 42.8461],
          'Romilly-sur-Seine': [3.7294, 48.5156],
          'La Chapelle-Saint-Luc': [4.0417, 48.3167],
          'Saint-André-les-Vergers': [4.0500, 48.2833],
          'Sainte-Savine': [4.0333, 48.2967],
          'Narbonne': [3.0044, 43.1839],
          'Castelnaudary': [1.9542, 43.3194],
          'Limoux': [2.2194, 43.0528],
          'Lézignan-Corbières': [2.7569, 43.2006],
          'Millau': [3.0786, 44.1000],
          'Villefranche-de-Rouergue': [2.0333, 44.3500],
          'Decazeville': [2.2533, 44.5600],
          'Onet-le-Château': [2.5844, 44.3664],
          'Martigues': [5.0547, 43.4056],
          'Aubagne': [5.5703, 43.2928],
          'Arles': [4.6278, 43.6767],
          'Hérouville-Saint-Clair': [-0.3342, 49.2006],
          'Lisieux': [0.2258, 49.1467],
          'Bayeux': [-0.7031, 49.2778],
          'Vire': [-0.8894, 48.8389],
          'Saint-Flour': [3.0933, 45.0333],
          'Mauriac': [2.3300, 45.2200],
          'Arpajon-sur-Cère': [2.4594, 44.9047],
          'Ytrac': [2.3575, 44.9122],
          'Cognac': [-0.3289, 45.6950],
          'Soyaux': [0.1950, 45.6403],
          'La Couronne': [0.1150, 45.6167],
          'Ruelle-sur-Touvre': [0.2150, 45.6833],
          'Rochefort': [-0.9603, 45.9403],
          'Saintes': [-0.6333, 45.7500],
          'Royan': [-1.0281, 45.6244],
          'Aytré': [-1.1272, 46.1322],
          'Vierzon': [2.0681, 47.2228],
          'Saint-Amand-Montrond': [2.5042, 46.7258],
          'Mehun-sur-Yèvre': [2.2189, 47.1436],
          'Saint-Doulchard': [2.3639, 47.1011],
          'Brive-la-Gaillarde': [1.5333, 45.1583],
          'Ussel': [2.3092, 45.5481],
          'Égletons': [2.0431, 45.4053],
          'Malemort-sur-Corrèze': [1.5650, 45.1700],
          'Privas': [4.5994, 44.7353],
          'Gap': [6.0806, 44.5594],
          'Valence': [4.8917, 44.9333],
          'Romans-sur-Isère': [5.0508, 45.0444],
          'Montélimar': [4.7508, 44.5583],
          'Pierrelatte': [4.7006, 44.3778],
          'Bourg-lès-Valence': [4.8931, 44.9478],
          'Grenoble': [5.7245, 45.1885],
          'Saint-Martin-d\'Hères': [5.7650, 45.1667],
          'Vienne': [4.8775, 45.5253],
          'Échirolles': [5.7183, 45.1458],
          'Bourgoin-Jallieu': [5.2758, 45.5856],
          'Saint-Étienne': [4.3872, 45.4397],
          'Roanne': [4.0672, 46.0356],
          'Saint-Chamond': [4.5153, 45.4764],
          'Firminy': [4.2894, 45.3883],
          'Montbrison': [4.0653, 45.6075],
          'Le Puy-en-Velay': [3.8836, 45.0433],
          'Monistrol-sur-Loire': [4.1736, 45.2942],
          'Yssingeaux': [4.1239, 45.1425],
          'Brioude': [3.3842, 45.2942],
          'Aurec-sur-Loire': [4.1994, 45.3697],
          'Aurillac': [2.4392, 44.9261],
          'Clermont-Ferrand': [3.0833, 45.7772],
          'Riom': [3.1147, 45.8942],
          'Cournon-d\'Auvergne': [3.1939, 45.7414],
          'Chamalières': [3.0667, 45.7747],
          'Issoire': [3.2486, 45.5436],
          'Lyon': [4.8357, 45.7640],
          'Chambéry': [5.9175, 45.5646],
          'Annecy': [6.1294, 45.8992],

          // Bourgogne-Franche-Comté
          'Dijon': [5.0417, 47.3220],
          'Beaune': [4.8394, 47.0256],
          'Chenôve': [5.0067, 47.2925],
          'Talant': [5.0097, 47.3389],
          'Quetigny': [5.0981, 47.3111],
          'Besançon': [6.0244, 47.2378],
          'Montbéliard': [6.7981, 47.5100],
          'Pontarlier': [6.3550, 46.9050],
          'Audincourt': [6.8408, 47.4825],
          'Valentigney': [6.8339, 47.4611],
          'Lons-le-Saunier': [5.5542, 46.6753],
          'Dole': [5.4917, 47.0931],
          'Saint-Claude': [5.8650, 46.3858],
          'Champagnole': [5.9069, 46.7472],
          'Morez': [6.0222, 46.5214],
          'Nevers': [3.1586, 46.9897],
          'Cosne-Cours-sur-Loire': [2.9261, 47.4131],
          'Varennes-Vauzelles': [3.1489, 46.9939],
          'Decize': [3.4597, 46.8286],
          'La Charité-sur-Loire': [3.0164, 47.1783],
          'Vesoul': [6.1542, 47.6228],
          'Luxeuil-les-Bains': [6.3783, 47.8200],
          'Héricourt': [6.7650, 47.5750],
          'Lure': [6.4961, 47.6856],
          'Gray': [5.5900, 47.4450],
          'Mâcon': [4.8331, 46.3067],
          'Chalon-sur-Saône': [4.8539, 46.7806],
          'Le Creusot': [4.4328, 46.8000],
          'Montceau-les-Mines': [4.3639, 46.6736],
          'Autun': [4.2989, 46.9517],
          'Auxerre': [3.5697, 47.7981],
          'Sens': [3.2833, 48.1978],
          'Joigny': [3.3969, 47.9833],
          'Avallon': [3.9094, 47.4900],
          'Migennes': [3.5167, 47.9650],
          'Belfort': [6.8628, 47.6383],
          'Delle': [6.9978, 47.5078],
          'Valdoie': [6.8322, 47.6656],
          'Beaucourt': [7.0383, 47.4878],
          'Danjoutin': [6.8639, 47.6139],

          // Bretagne
          'Saint-Brieuc': [-2.7608, 48.5139],
          'Lannion': [-3.4597, 48.7322],
          'Plérin': [-2.7706, 48.5378],
          'Lamballe': [-2.5158, 48.4700],
          'Dinan': [-2.0500, 48.4533],
          'Brest': [-4.4861, 48.3900],
          'Quimper': [-4.0978, 47.9960],
          'Concarneau': [-3.9186, 47.8733],
          'Morlaix': [-3.8281, 48.5778],
          'Douarnenez': [-4.3336, 48.0936],
          'Rennes': [-1.6778, 48.1173],
          'Saint-Malo': [-2.0258, 48.6500],
          'Fougères': [-1.1978, 48.3522],
          'Vitré': [-1.2092, 48.1231],
          'Cesson-Sévigné': [-1.6031, 48.1217],
          'Vannes': [-2.7597, 47.6578],
          'Lorient': [-3.3700, 47.7483],
          'Lanester': [-3.3400, 47.7633],
          'Ploemeur': [-3.4350, 47.7367],
          'Hennebont': [-3.2764, 47.8056],

          // Centre-Val de Loire
          'Bourges': [2.3964, 47.0844],
          'Chartres': [1.4878, 48.4469],
          'Dreux': [1.3667, 48.7333],
          'Lucé': [1.4578, 48.4400],
          'Châteaudun': [1.3381, 48.0708],
          'Mainvilliers': [1.4619, 48.4533],
          'Châteauroux': [1.6914, 46.8117],
          'Issoudun': [1.9928, 46.9489],
          'Le Blanc': [1.0633, 46.6328],
          'La Châtre': [1.9894, 46.5814],
          'Argenton-sur-Creuse': [1.5194, 46.5881],
          'Tours': [0.6892, 47.3941],
          'Joué-lès-Tours': [0.6658, 47.3528],
          'Saint-Pierre-des-Corps': [0.7203, 47.3900],
          'Saint-Cyr-sur-Loire': [0.6672, 47.4008],
          'Amboise': [0.9833, 47.4131],
          'Blois': [1.3289, 47.5867],
          'Romorantin-Lanthenay': [1.7406, 47.3575],
          'Vendôme': [1.0658, 47.7933],
          'Vineuil': [1.3747, 47.5828],
          'Saint-Gervais-la-Forêt': [1.3586, 47.5678],
          'Orléans': [1.9042, 47.9029],
          'Fleury-les-Aubrais': [1.9181, 47.9272],
          'Olivet': [1.9000, 47.8667],
          'Saint-Jean-de-Braye': [1.9728, 47.9117],
          'Châlette-sur-Loing': [2.7339, 48.0111],

          // Corse
          'Ajaccio': [8.7369, 41.9267],
          'Porto-Vecchio': [9.2789, 41.5914],
          'Propriano': [8.9042, 41.6767],
          'Sartène': [8.9728, 41.6222],
          'Bonifacio': [9.1594, 41.3874],
          'Bastia': [9.4500, 42.7028],
          'Corte': [9.1500, 42.3067],
          'Calvi': [8.7561, 42.5678],
          'L\'Île-Rousse': [8.9378, 42.6378],
          'Biguglia': [9.4328, 42.6106],

          // Grand Est
          'Charleville-Mézières': [4.7197, 49.7722],
          'Troyes': [4.0786, 48.2972],
          'Reims': [4.0317, 49.2583],
          'Épernay': [3.9592, 49.0417],
          'Vitry-le-François': [4.5850, 48.7250],
          'Tinqueux': [3.9906, 49.2489],
          'Châlons-en-Champagne': [4.3631, 48.9575],
          'Chaumont': [5.1389, 48.1111],
          'Saint-Dizier': [4.9500, 48.6333],
          'Langres': [5.3339, 47.8619],
          'Nogent': [5.3500, 48.0167],
          'Joinville': [5.1419, 48.4428],
          'Nancy': [6.1839, 48.6921],
          'Vandœuvre-lès-Nancy': [6.1711, 48.6569],
          'Lunéville': [6.4978, 48.5933],
          'Toul': [5.8928, 48.6750],
          'Villers-lès-Nancy': [6.1525, 48.6761],
          'Bar-le-Duc': [5.1603, 48.7708],
          'Verdun': [5.3833, 49.1600],
          'Commercy': [5.5906, 48.7611],
          'Saint-Mihiel': [5.5411, 48.8889],
          'Stenay': [5.1864, 49.4897],
          'Metz': [6.1758, 49.1193],
          'Thionville': [6.1681, 49.3581],
          'Montigny-lès-Metz': [6.1531, 49.1006],
          'Forbach': [6.8981, 49.1886],
          'Sarreguemines': [7.0678, 49.1111],
          'Strasbourg': [7.7521, 48.5734],
          'Haguenau': [7.7908, 48.8150],
          'Schiltigheim': [7.7494, 48.6069],
          'Illkirch-Graffenstaden': [7.7194, 48.5297],
          'Sélestat': [7.4572, 48.2603],
          'Colmar': [7.3581, 48.0778],
          'Saint-Louis': [7.5597, 47.5889],
          'Wittenheim': [7.3389, 47.8083],
          'Illzach': [7.3478, 47.7750],
          'Épinal': [6.4497, 48.1731],
          'Saint-Dié-des-Vosges': [6.9500, 48.2833],
          'Gérardmer': [6.8794, 48.0717],
          'Remiremont': [6.5917, 48.0167],
          'Golbey': [6.4431, 48.1944],

          // Hauts-de-France
          'Laon': [3.6250, 49.5639],
          'Lille': [3.0573, 50.6292],
          'Tourcoing': [3.1606, 50.7236],
          'Roubaix': [3.1739, 50.6942],
          'Dunkerque': [2.3772, 51.0342],
          'Villeneuve-d\'Ascq': [3.1456, 50.6194],
          'Beauvais': [2.0839, 49.4295],
          'Compiègne': [2.8258, 49.4178],
          'Creil': [2.4731, 49.2603],
          'Senlis': [2.5861, 49.2069],
          'Nogent-sur-Oise': [2.4717, 49.2739],
          'Arras': [2.7733, 50.2917],
          'Boulogne-sur-Mer': [1.6139, 50.7264],
          'Calais': [1.8586, 50.9481],
          'Lens': [2.8308, 50.4283],
          'Liévin': [2.7733, 50.4200],
          'Amiens': [2.2958, 49.8942],
          'Abbeville': [1.8350, 50.1050],
          'Albert': [2.6517, 50.0031],
          'Péronne': [2.9325, 49.9292],
          'Montdidier': [2.5697, 49.6478],

          // Île-de-France
          'Paris': [2.3522, 48.8566],
          'Meaux': [2.8883, 48.9606],
          'Melun': [2.6597, 48.5392],
          'Chelles': [2.5978, 48.8800],
          'Pontault-Combault': [2.6056, 48.7967],
          'Savigny-le-Temple': [2.5856, 48.5789],
          'Versailles': [2.1301, 48.8014],
          'Sartrouville': [2.1656, 48.9372],
          'Mantes-la-Jolie': [1.7181, 48.9906],
          'Saint-Germain-en-Laye': [2.0939, 48.8978],
          'Poissy': [2.0464, 48.9283],
          'Évry-Courcouronnes': [2.4289, 48.6281],
          'Corbeil-Essonnes': [2.4789, 48.6103],
          'Massy': [2.2731, 48.7306],
          'Savigny-sur-Orge': [2.3458, 48.6792],
          'Sainte-Geneviève-des-Bois': [2.3339, 48.6431],
          'Nanterre': [2.2069, 48.8925],
          'Boulogne-Billancourt': [2.2394, 48.8356],
          'Colombes': [2.2531, 48.9239],
          'Asnières-sur-Seine': [2.2856, 48.9144],
          'Courbevoie': [2.2558, 48.8978],
          'Bobigny': [2.4394, 48.9075],
          'Saint-Denis': [2.3544, 48.9361],
          'Montreuil': [2.4431, 48.8633],
          'Aubervilliers': [2.3839, 48.9139],
          'Aulnay-sous-Bois': [2.4950, 48.9533],
          'Créteil': [2.4656, 48.7908],
          'Vitry-sur-Seine': [2.3933, 48.7878],
          'Champigny-sur-Marne': [2.4950, 48.8175],
          'Saint-Maur-des-Fossés': [2.4950, 48.7994],
          'Ivry-sur-Seine': [2.3850, 48.8139],
          'Cergy': [2.0772, 49.0369],
          'Argenteuil': [2.2475, 48.9475],
          'Sarcelles': [2.3769, 48.9981],
          'Garges-lès-Gonesse': [2.3978, 48.9722],
          'Franconville': [2.2281, 48.9889],

          // Normandie
          'Caen': [-0.3708, 49.1829],
          'Évreux': [1.1508, 49.0242],
          'Louviers': [1.1672, 49.2144],
          'Vernon': [1.4856, 49.0936],
          'Val-de-Reuil': [1.2136, 49.2739],
          'Gisors': [1.7767, 49.2800],
          'Saint-Lô': [-1.0911, 49.1153],
          'Cherbourg-en-Cotentin': [-1.6244, 49.6394],
          'Équeurdreville-Hainneville': [-1.6506, 49.6408],
          'Tourlaville': [-1.5758, 49.6369],
          'Granville': [-1.5978, 48.8378],
          'Alençon': [0.0894, 48.4328],
          'Flers': [-0.5706, 48.7500],
          'Argentan': [0.0208, 48.7439],
          'L\'Aigle': [0.6306, 48.7644],
          'La Ferté-Macé': [-0.3600, 48.5933],
          'Rouen': [1.0993, 49.4432],
          'Le Havre': [0.1078, 49.4944],
          'Dieppe': [1.0775, 49.9233],
          'Sotteville-lès-Rouen': [1.0928, 49.4133],
          'Saint-Étienne-du-Rouvray': [1.0989, 49.3839],

          // Nouvelle-Aquitaine
          'Angoulême': [0.1608, 45.6484],
          'La Rochelle': [-1.1508, 46.1603],
          'Tulle': [1.7667, 45.2667],
          'Guéret': [1.8706, 46.1700],
          'Aubusson': [2.1689, 45.9564],
          'La Souterraine': [1.4856, 46.2394],
          'Bourganeuf': [1.7539, 45.9544],
          'Chambon-sur-Voueize': [2.4300, 46.1917],
          'Périgueux': [0.7211, 45.1844],
          'Bergerac': [0.4817, 44.8511],
          'Sarlat-la-Canéda': [1.2167, 44.8911],
          'Coulounieix-Chamiers': [0.6925, 45.1594],
          'Trélissac': [0.7833, 45.1900],
          'Bordeaux': [-0.5792, 44.8378],
          'Mérignac': [-0.6433, 44.8397],
          'Pessac': [-0.6306, 44.8064],
          'Talence': [-0.5922, 44.8083],
          'Villenave-d\'Ornon': [-0.5594, 44.7750],
          'Mont-de-Marsan': [-0.5000, 43.8900],
          'Dax': [-1.0500, 43.7100],
          'Biscarrosse': [-1.1653, 44.3942],
          'Saint-Paul-lès-Dax': [-1.0533, 43.7283],
          'Tarnos': [-1.4650, 43.5419],
          'Agen': [0.6211, 44.2028],
          'Villeneuve-sur-Lot': [0.7044, 44.4078],
          'Marmande': [0.1667, 44.5000],
          'Le Passage': [0.5964, 44.2011],
          'Nérac': [0.3400, 44.1353],
          'Cahors': [1.4411, 44.4481],
          'Figeac': [2.0333, 44.6083],
          'Gourdon': [1.3828, 44.7383],
          'Souillac': [1.4783, 44.8933],
          'Prayssac': [1.1856, 44.5031],
          'Pau': [-0.3706, 43.2964],
          'Bayonne': [-1.4747, 43.4928],
          'Anglet': [-1.5233, 43.4831],
          'Biarritz': [-1.5586, 43.4808],
          'Hendaye': [-1.7736, 43.3567],
          'Niort': [-0.4597, 46.3236],
          'Bressuire': [-0.4889, 46.8428],
          'Thouars': [-0.2156, 46.9775],
          'Parthenay': [-0.2500, 46.6500],
          'Saint-Maixent-l\'École': [-0.2056, 46.4128],
          'Poitiers': [0.3333, 46.5833],
          'Châtellerault': [0.5461, 46.8178],
          'Buxerolles': [0.3478, 46.5961],
          'Loudun': [0.0828, 47.0086],
          'Saint-Benoît': [0.3406, 46.5494],
          'Limoges': [1.2578, 45.8336],
          'Saint-Junien': [0.9019, 45.8856],
          'Panazol': [1.3131, 45.8406],
          'Couzeix': [1.2353, 45.8636],
          'Le Palais-sur-Vienne': [1.3272, 45.8689],

          // Occitanie
          'Foix': [1.6058, 42.9656],
          'Carcassonne': [2.3492, 43.2130],
          'Rodez': [2.5753, 44.3508],
          'Nîmes': [4.3608, 43.8367],
          'Alès': [4.0806, 44.1250],
          'Bagnols-sur-Cèze': [4.6217, 44.1614],
          'Beaucaire': [4.6428, 43.8072],
          'Saint-Gilles': [4.4303, 43.6778],
          'Toulouse': [1.4442, 43.6047],
          'Colomiers': [1.3333, 43.6111],
          'Tournefeuille': [1.3431, 43.5864],
          'Muret': [1.3272, 43.4633],
          'Blagnac': [1.3906, 43.6356],
          'Auch': [0.5850, 43.6461],
          'Condom': [0.3722, 43.9589],
          'Fleurance': [0.6650, 43.8483],
          'L\'Isle-Jourdain': [1.0800, 43.6133],
          'Mirande': [0.4022, 43.5133],
          'Montpellier': [3.8767, 43.6108],
          'Béziers': [3.2147, 43.3442],
          'Sète': [3.6972, 43.4031],
          'Lunel': [4.1358, 43.6758],
          'Agde': [3.4756, 43.3089],
          'Mende': [3.5006, 44.5181],
          'Florac': [3.5958, 44.3267],
          'Marvejols': [3.2908, 44.5550],
          'Saint-Chély-d\'Apcher': [3.2778, 44.8056],
          'Langogne': [3.8578, 44.7272],
          'Tarbes': [0.0800, 43.2333],
          'Lourdes': [-0.0467, 43.0933],
          'Bagnères-de-Bigorre': [0.1500, 43.0650],
          'Aureilhan': [0.0944, 43.2425],
          'Lannemezan': [0.3869, 43.1264],
          'Perpignan': [2.8954, 42.6886],
          'Canet-en-Roussillon': [3.0183, 42.6989],
          'Saint-Estève': [2.8408, 42.7100],
          'Argelès-sur-Mer': [3.0242, 42.5461],
          'Céret': [2.7528, 42.4869],
          'Albi': [2.1481, 43.9289],
          'Castres': [2.2406, 43.6053],
          'Gaillac': [1.8989, 43.9014],
          'Graulhet': [1.9889, 43.7611],
          'Mazamet': [2.3742, 43.4908],
          'Montauban': [1.3556, 44.0178],
          'Castelsarrasin': [1.1100, 44.0408],
          'Moissac': [1.0850, 44.1053],
          'Caussade': [1.5350, 44.1622],
          'Valence': [1.3800, 44.1050],

          // Pays de la Loire
          'Nantes': [-1.5536, 47.2184],
          'Saint-Nazaire': [-2.2136, 47.2733],
          'Saint-Herblain': [-1.6511, 47.2167],
          'Rezé': [-1.5506, 47.1833],
          'Saint-Sébastien-sur-Loire': [-1.5006, 47.2067],
          'Angers': [-0.5633, 47.4784],
          'Cholet': [-0.8792, 47.0608],
          'Saumur': [-0.0769, 47.2600],
          'Avrillé': [-0.5939, 47.5025],
          'Les Ponts-de-Cé': [-0.5200, 47.4233],
          'Laval': [-0.7703, 48.0694],
          'Mayenne': [-0.6167, 48.3000],
          'Château-Gontier': [-0.7042, 47.8278],
          'Évron': [-0.4028, 48.1556],
          'Changé': [-0.7908, 48.0983],
          'Le Mans': [0.1996, 47.9952],
          'Sablé-sur-Sarthe': [-0.3389, 47.8400],
          'Allonnes': [0.1658, 47.9678],
          'La Flèche': [-0.0744, 47.6983],
          'Coulaines': [0.2089, 48.0206],
          'La Roche-sur-Yon': [-1.4328, 46.6703],
          'Les Sables-d\'Olonne': [-1.7833, 46.4967],
          'Challans': [-1.8786, 46.8469],
          'Fontenay-le-Comte': [-0.8050, 46.4656],
          'Luçon': [-1.1667, 46.4553],

          // Provence-Alpes-Côte d'Azur
          'Digne-les-Bains': [6.2361, 44.0936],
          'Briançon': [6.6408, 44.8997],
          'Nice': [7.2619, 43.7102],
          'Cannes': [7.0169, 43.5528],
          'Antibes': [7.1258, 43.5808],
          'Grasse': [6.9244, 43.6586],
          'Menton': [7.5050, 43.7750],
          'Marseille': [5.3698, 43.2965],
          'Aix-en-Provence': [5.4474, 43.5297],
          'Toulon': [5.9280, 43.1242],
          'La Seyne-sur-Mer': [5.8808, 43.1019],
          'Hyères': [6.1294, 43.1203],
          'Fréjus': [6.7358, 43.4331],
          'Draguignan': [6.4656, 43.5378],
          'Avignon': [4.8075, 43.9493],
          'Carpentras': [5.0481, 44.0556],
          'Orange': [4.8078, 44.1361],
          'Cavaillon': [5.0378, 43.8378],
          'Apt': [5.3956, 43.8767],

          // Rhône
          'Villeurbanne': [4.8800, 45.7667],
          'Vénissieux': [4.8872, 45.6975],
          'Caluire-et-Cuire': [4.8492, 45.7950],
          'Saint-Priest': [4.9436, 45.6953],

          // Savoie
          'Aix-les-Bains': [5.9150, 45.6886],
          'Albertville': [6.3917, 45.6756],
          'Saint-Jean-de-Maurienne': [6.3456, 45.2772],
          'Montmélian': [6.0531, 45.5050],

          // Haute-Savoie
          'Thonon-les-Bains': [6.4792, 46.3706],
          'Annemasse': [6.2364, 46.1947],
          'Cluses': [6.5778, 45.9875],
          'Évian-les-Bains': [6.5917, 46.4000],

          // Missing cities - completing the list
          'Oyonnax': [5.6556, 46.2564],
          'Grasse': [6.9244, 43.6586],
          'Menton': [7.5050, 43.7750],
          'La Seyne-sur-Mer': [5.8808, 43.1019],
          'Hyères': [6.1294, 43.1203],
          'Fréjus': [6.7358, 43.4331],
          'Draguignan': [6.4656, 43.5378],
          'Carpentras': [5.0481, 44.0556],
          'Orange': [4.8078, 44.1361],
          'Cavaillon': [5.0378, 43.8378],
          'Apt': [5.3956, 43.8767],
          'Saint-Malo': [- 2.0258, 48.6500],
          'Fougères': [-1.1978, 48.3522],
          'Vitré': [-1.2092, 48.1231],
          'Cesson-Sévigné': [-1.6031, 48.1217],
          'Issoudun': [1.9928, 46.9489],
          'Le Blanc': [1.0633, 46.6328],
          'La Châtre': [1.9894, 46.5814],
          'Argenton-sur-Creuse': [1.5194, 46.5881],
          'Joué-lès-Tours': [0.6658, 47.3528],
          'Saint-Pierre-des-Corps': [0.7203, 47.3900],
          'Saint-Cyr-sur-Loire': [0.6672, 47.4008],
          'Amboise': [0.9833, 47.4131],
          'Romorantin-Lanthenay': [1.7406, 47.3575],
          'Vendôme': [1.0658, 47.7933],
          'Vineuil': [1.3747, 47.5828],
          'Saint-Gervais-la-Forêt': [1.3586, 47.5678],
          'Fleury-les-Aubrais': [1.9181, 47.9272],
          'Olivet': [1.9000, 47.8667],
          'Saint-Jean-de-Braye': [1.9728, 47.9117],
          'Châlette-sur-Loing': [2.7339, 48.0111],
          'Figeac': [2.0333, 44.6083],
          'Gourdon': [1.3828, 44.7383],
          'Souillac': [1.4783, 44.8933],
          'Prayssac': [1.1856, 44.5031],
          'Villeneuve-sur-Lot': [0.7044, 44.4078],
          'Marmande': [0.1667, 44.5000],
          'Le Passage': [0.5964, 44.2011],
          'Nérac': [0.3400, 44.1353],
          'Florac': [3.5958, 44.3267],
          'Marvejols': [3.2908, 44.5550],
          'Saint-Chély-d\'Apcher': [3.2778, 44.8056],
          'Langogne': [3.8578, 44.7272],
          'Cholet': [-0.8792, 47.0608],
          'Saumur': [-0.0769, 47.2600],
          'Avrillé': [-0.5939, 47.5025],
          'Les Ponts-de-Cé': [-0.5200, 47.4233],
          'Cherbourg-en-Cotentin': [-1.6244, 49.6394],
          'Équeurdreville-Hainneville': [-1.6506, 49.6408],
          'Tourlaville': [-1.5758, 49.6369],
          'Granville': [-1.5978, 48.8378],
          'Mayenne': [-0.6167, 48.3000],
          'Château-Gontier': [-0.7042, 47.8278],
          'Évron': [-0.4028, 48.1556],
          'Changé': [-0.7908, 48.0983],
          'Saint-Nazaire': [-2.2136, 47.2733],
          'Saint-Herblain': [-1.6511, 47.2167],
          'Rezé': [-1.5506, 47.1833],
          'Saint-Sébastien-sur-Loire': [-1.5006, 47.2067],
          'Flers': [-0.5706, 48.7500],
          'Argentan': [0.0208, 48.7439],
          'L\'Aigle': [0.6306, 48.7644],
          'La Ferté-Macé': [-0.3600, 48.5933],
          'Boulogne-sur-Mer': [1.6139, 50.7264],
          'Calais': [1.8586, 50.9481],
          'Lens': [2.8308, 50.4283],
          'Liévin': [2.7733, 50.4200],
          'Anglet': [-1.5233, 43.4831],
          'Hendaye': [-1.7736, 43.3567],
          'Bagnères-de-Bigorre': [0.1500, 43.0650],
          'Aureilhan': [0.0944, 43.2425],
          'Lannemezan': [0.3869, 43.1264],
          'Canet-en-Roussillon': [3.0183, 42.6989],
          'Saint-Estève': [2.8408, 42.7100],
          'Argelès-sur-Mer': [3.0242, 42.5461],
          'Céret': [2.7528, 42.4869],
          'Haguenau': [7.7908, 48.8150],
          'Schiltigheim': [7.7494, 48.6069],
          'Illkirch-Graffenstaden': [7.7194, 48.5297],
          'Sélestat': [7.4572, 48.2603],
          'Saint-Louis': [7.5597, 47.5889],
          'Wittenheim': [7.3389, 47.8083],
          'Illzach': [7.3478, 47.7750],
          'Villeurbanne': [4.8800, 45.7667],
          'Vénissieux': [4.8872, 45.6975],
          'Caluire-et-Cuire': [4.8492, 45.7950],
          'Saint-Priest': [4.9436, 45.6953],
          'Luxeuil-les-Bains': [6.3783, 47.8200],
          'Héricourt': [6.7650, 47.5750],
          'Lure': [6.4961, 47.6856],
          'Gray': [5.5900, 47.4450],
          'Chalon-sur-Saône': [4.8539, 46.7806],
          'Le Creusot': [4.4328, 46.8000],
          'Montceau-les-Mines': [4.3639, 46.6736],
          'Autun': [4.2989, 46.9517],
          'Sablé-sur-Sarthe': [-0.3389, 47.8400],
          'Allonnes': [0.1658, 47.9678],
          'La Flèche': [-0.0744, 47.6983],
          'Coulaines': [0.2089, 48.0206],
          'Aix-les-Bains': [5.9150, 45.6886],
          'Albertville': [6.3917, 45.6756],
          'Saint-Jean-de-Maurienne': [6.3456, 45.2772],
          'Montmélian': [6.0531, 45.5050],
          'Meaux': [2.8883, 48.9606],
          'Chelles': [2.5978, 48.8800],
          'Pontault-Combault': [2.6056, 48.7967],
          'Savigny-le-Temple': [2.5856, 48.5789],
          'Sartrouville': [2.1656, 48.9372],
          'Mantes-la-Jolie': [1.7181, 48.9906],
          'Saint-Germain-en-Laye': [2.0939, 48.8978],
          'Poissy': [2.0464, 48.9283],
          'Corbeil-Essonnes': [2.4789, 48.6103],
          'Massy': [2.2731, 48.7306],
          'Savigny-sur-Orge': [2.3458, 48.6792],
          'Sainte-Geneviève-des-Bois': [2.3339, 48.6431],
          'Boulogne-Billancourt': [2.2394, 48.8356],
          'Colombes': [2.2531, 48.9239],
          'Asnières-sur-Seine': [2.2856, 48.9144],
          'Courbevoie': [2.2558, 48.8978],
          'Saint-Denis': [2.3544, 48.9361],
          'Montreuil': [2.4431, 48.8633],
          'Aubervilliers': [2.3839, 48.9139],
          'Aulnay-sous-Bois': [2.4950, 48.9533],
          'Vitry-sur-Seine': [2.3933, 48.7878],
          'Champigny-sur-Marne': [2.4950, 48.8175],
          'Saint-Maur-des-Fossés': [2.4950, 48.7994],
          'Ivry-sur-Seine': [2.3850, 48.8139],
          'Argenteuil': [2.2475, 48.9475],
          'Sarcelles': [2.3769, 48.9981],
          'Garges-lès-Gonesse': [2.3978, 48.9722],
          'Franconville': [2.2281, 48.9889],
          'Dieppe': [1.0775, 49.9233],
          'Sotteville-lès-Rouen': [1.0928, 49.4133],
          'Saint-Étienne-du-Rouvray': [1.0989, 49.3839],
          'Bressuire': [-0.4889, 46.8428],
          'Thouars': [-0.2156, 46.9775],
          'Parthenay': [-0.2500, 46.6500],
          'Saint-Maixent-l\'École': [-0.2056, 46.4128],
          'Abbeville': [1.8350, 50.1050],
          'Albert': [2.6517, 50.0031],
          'Péronne': [2.9325, 49.9292],
          'Montdidier': [2.5697, 49.6478],
          'Castres': [2.2406, 43.6053],
          'Gaillac': [1.8989, 43.9014],
          'Graulhet': [1.9889, 43.7611],
          'Mazamet': [2.3742, 43.4908],
          'Castelsarrasin': [1.1100, 44.0408],
          'Moissac': [1.0850, 44.1053],
          'Caussade': [1.5350, 44.1622],
          'Les Sables-d\'Olonne': [-1.7833, 46.4967],
          'Challans': [-1.8786, 46.8469],
          'Fontenay-le-Comte': [-0.8050, 46.4656],
          'Luçon': [-1.1667, 46.4553],
          'Châtellerault': [0.5461, 46.8178],
          'Buxerolles': [0.3478, 46.5961],
          'Loudun': [0.0828, 47.0086],
          'Saint-Benoît': [0.3406, 46.5494],
          'Saint-Junien': [0.9019, 45.8856],
          'Panazol': [1.3131, 45.8406],
          'Couzeix': [1.2353, 45.8636],
          'Le Palais-sur-Vienne': [1.3272, 45.8689],
          'Saint-Dié-des-Vosges': [6.9500, 48.2833],
          'Gérardmer': [6.8794, 48.0717],
          'Remiremont': [6.5917, 48.0167],
          'Golbey': [6.4431, 48.1944],
          'Sens': [3.2833, 48.1978],
          'Joigny': [3.3969, 47.9833],
          'Avallon': [3.9094, 47.4900],
          'Migennes': [3.5167, 47.9650],
          'Delle': [6.9978, 47.5078],
          'Valdoie': [6.8322, 47.6656],
          'Beaucourt': [7.0383, 47.4878],
          'Danjoutin': [6.8639, 47.6139],
          'Louviers': [1.1672, 49.2144],
          'Vernon': [1.4856, 49.0936],
          'Val-de-Reuil': [1.2136, 49.2739],
          'Gisors': [1.7767, 49.2800],
          'Dreux': [1.3667, 48.7333],
          'Lucé': [1.4578, 48.4400],
          'Châteaudun': [1.3381, 48.0708],
          'Mainvilliers': [1.4619, 48.4533],
          'Concarneau': [-3.9186, 47.8733],
          'Morlaix': [-3.8281, 48.5778],
          'Douarnenez': [-4.3336, 48.0936],
          'Porto-Vecchio': [9.2789, 41.5914],
          'Propriano': [8.9042, 41.6767],
          'Sartène': [8.9728, 41.6222],
          'Bonifacio': [9.1594, 41.3874],
          'Bastia': [9.4500, 42.7028],
          'Corte': [9.1500, 42.3067],
          'Calvi': [8.7561, 42.5678],
          'L\'Île-Rousse': [8.9378, 42.6378],
          'Biguglia': [9.4328, 42.6106],
          'Alès': [4.0806, 44.1250],
          'Bagnols-sur-Cèze': [4.6217, 44.1614],
          'Beaucaire': [4.6428, 43.8072],
          'Saint-Gilles': [4.4303, 43.6778],
          'Colomiers': [1.3333, 43.6111],
          'Tournefeuille': [1.3431, 43.5864],
          'Muret': [1.3272, 43.4633],
          'Blagnac': [1.3906, 43.6356],
          'Condom': [0.3722, 43.9589],
          'Fleurance': [0.6650, 43.8483],
          'L\'Isle-Jourdain': [1.0800, 43.6133],
          'Mirande': [0.4022, 43.5133],
          'Mérignac': [-0.6433, 44.8397],
          'Pessac': [-0.6306, 44.8064],
          'Talence': [-0.5922, 44.8083],
          'Villenave-d\'Ornon': [-0.5594, 44.7750],
          'Béziers': [3.2147, 43.3442],
          'Sète': [3.6972, 43.4031],
          'Lunel': [4.1358, 43.6758],
          'Agde': [3.4756, 43.3089],
          'Lannion': [-3.4597, 48.7322],
          'Plérin': [-2.7706, 48.5378],
          'Lamballe': [-2.5158, 48.4700],
          'Dinan': [-2.0500, 48.4533],
          'Aubusson': [2.1689, 45.9564],
          'La Souterraine': [1.4856, 46.2394],
          'Bourganeuf': [1.7539, 45.9544],
          'Chambon-sur-Voueize': [2.4300, 46.1917],
          'Bergerac': [0.4817, 44.8511],
          'Sarlat-la-Canéda': [1.2167, 44.8911],
          'Coulounieix-Chamiers': [0.6925, 45.1594],
          'Trélissac': [0.7833, 45.1900],
          'Montbéliard': [6.7981, 47.5100],
          'Pontarlier': [6.3550, 46.9050],
          'Audincourt': [6.8408, 47.4825],
          'Valentigney': [6.8339, 47.4611],
          'Dole': [5.4917, 47.0931],
          'Saint-Claude': [5.8650, 46.3858],
          'Champagnole': [5.9069, 46.7472],
          'Morez': [6.0222, 46.5214],
          'Dax': [-1.0500, 43.7100],
          'Biscarrosse': [-1.1653, 44.3942],
          'Saint-Paul-lès-Dax': [-1.0533, 43.7283],
          'Tarnos': [-1.4650, 43.5419],
          'Cosne-Cours-sur-Loire': [2.9261, 47.4131],
          'Varennes-Vauzelles': [3.1489, 46.9939],
          'Decize': [3.4597, 46.8286],
          'La Charité-sur-Loire': [3.0164, 47.1783],
          'Villeneuve-d\'Ascq': [3.1456, 50.6194],
          'Compiègne': [2.8258, 49.4178],
          'Creil': [2.4731, 49.2603],
          'Senlis': [2.5861, 49.2069],
          'Nogent-sur-Oise': [2.4717, 49.2739],
          'Vandœuvre-lès-Nancy': [6.1711, 48.6569],
          'Lunéville': [6.4978, 48.5933],
          'Toul': [5.8928, 48.6750],
          'Villers-lès-Nancy': [6.1525, 48.6761],
          'Verdun': [5.3833, 49.1600],
          'Commercy': [5.5906, 48.7611],
          'Saint-Mihiel': [5.5411, 48.8889],
          'Stenay': [5.1864, 49.4897],
          'Lorient': [-3.3700, 47.7483],
          'Lanester': [-3.3400, 47.7633],
          'Ploemeur': [-3.4350, 47.7367],
          'Hennebont': [-3.2764, 47.8056],
          'Thionville': [6.1681, 49.3581],
          'Montigny-lès-Metz': [6.1531, 49.1006],
          'Forbach': [6.8981, 49.1886],
          'Sarreguemines': [7.0678, 49.1111],
          'Beaune': [4.8394, 47.0256],
          'Chenôve': [5.0067, 47.2925],
          'Talant': [5.0097, 47.3389],
          'Quetigny': [5.0981, 47.3111],
          'Hérouville-Saint-Clair': [-0.3342, 49.2006],
          'Lisieux': [0.2258, 49.1467],
          'Bayeux': [-0.7031, 49.2778],
          'Vire': [-0.8894, 48.8389],
          'Saint-Flour': [3.0933, 45.0333],
          'Mauriac': [2.3300, 45.2200],
          'Arpajon-sur-Cère': [2.4594, 44.9047],
          'Ytrac': [2.3575, 44.9122],
          'Cognac': [-0.3289, 45.6950],
          'Soyaux': [0.1950, 45.6403],
          'La Couronne': [0.1150, 45.6167],
          'Ruelle-sur-Touvre': [0.2150, 45.6833],
          'Rochefort': [-0.9603, 45.9403],
          'Saintes': [-0.6333, 45.7500],
          'Royan': [-1.0281, 45.6244],
          'Aytré': [-1.1272, 46.1322],
          'Vierzon': [2.0681, 47.2228],
          'Saint-Amand-Montrond': [2.5042, 46.7258],
          'Mehun-sur-Yèvre': [2.2189, 47.1436],
          'Saint-Doulchard': [2.3639, 47.1011],
          'Brive-la-Gaillarde': [1.5333, 45.1583],
          'Ussel': [2.3092, 45.5481],
          'Égletons': [2.0431, 45.4053],
          'Malemort-sur-Corrèze': [1.5650, 45.1700],
          'Sedan': [4.9394, 49.7011],
          'Rethel': [4.3644, 49.5111],
          'Givet': [4.8261, 50.1386],
          'Revin': [4.6383, 49.9386],
          'Pamiers': [1.6108, 43.1156],
          'Saint-Girons': [1.1450, 42.9833],
          'Lavelanet': [1.8447, 42.9328],
          'Tarascon-sur-Ariège': [1.6094, 42.8461],
          'Romilly-sur-Seine': [3.7294, 48.5156],
          'La Chapelle-Saint-Luc': [4.0417, 48.3167],
          'Saint-André-les-Vergers': [4.0500, 48.2833],
          'Sainte-Savine': [4.0333, 48.2967],
          'Narbonne': [3.0044, 43.1839],
          'Castelnaudary': [1.9542, 43.3194],
          'Limoux': [2.2194, 43.0528],
          'Lézignan-Corbières': [2.7569, 43.2006],
          'Millau': [3.0786, 44.1000],
          'Villefranche-de-Rouergue': [2.0333, 44.3500],
          'Decazeville': [2.2533, 44.5600],
          'Onet-le-Château': [2.5844, 44.3664],
          'Martigues': [5.0547, 43.4056],
          'Aubagne': [5.5703, 43.2928],
          'Arles': [4.6278, 43.6767],
          'Manosque': [5.7867, 43.8306],
          'Sisteron': [5.9450, 44.1944],
          'Barcelonnette': [6.6542, 44.3856],
          'Castellane': [6.5139, 43.8472],
          'Embrun': [6.4956, 44.5656],
          'L\'Argentière-la-Bessée': [6.5550, 44.7850],
          'Tallard': [6.0531, 44.4628],
          'Annonay': [4.6700, 45.2400],
          'Aubenas': [4.3900, 44.6200],
          'Tournon-sur-Rhône': [4.8333, 45.0667],
          'Guilherand-Granges': [4.8733, 44.9333],
          'Épernay': [3.9592, 49.0417],
          'Vitry-le-François': [4.5850, 48.7250],
          'Tinqueux': [3.9906, 49.2489],
          'Saint-Dizier': [4.9500, 48.6333],
          'Langres': [5.3339, 47.8619],
          'Nogent': [5.3500, 48.0167],
          'Joinville': [5.1419, 48.4428],
          'Thonon-les-Bains': [6.4792, 46.3706],
          'Annemasse': [6.2364, 46.1947],
          'Cluses': [6.5778, 45.9875],
          'Évian-les-Bains': [6.5917, 46.4000]
        };

        const departmentInfo = {
          '01': { name: 'Ain', cities: ['Bourg-en-Bresse', 'Oyonnax', 'Ambérieu-en-Bugey', 'Belley', 'Miribel', 'Ferney-Voltaire', 'Gex', 'Divonne-les-Bains', 'Trévoux', 'Nantua'] },
          '02': { name: 'Aisne', cities: ['Saint-Quentin', 'Laon', 'Soissons', 'Château-Thierry', 'Tergnier', 'Chauny', 'Hirson', 'Villers-Cotterêts', 'Bohain-en-Vermandois', 'Vervins'] },
          '03': { name: 'Allier', cities: ['Montluçon', 'Vichy', 'Moulins', 'Yzeure', 'Cusset', 'Domérat', 'Bellerive-sur-Allier', 'Commentry', 'Désertines', 'Gannat'] },
          '04': { name: 'Alpes-de-Haute-Provence', cities: ['Digne-les-Bains', 'Manosque', 'Sisteron', 'Barcelonnette', 'Castellane'] },
          '05': { name: 'Hautes-Alpes', cities: ['Gap', 'Briançon', 'Embrun', 'L\'Argentière-la-Bessée', 'Tallard'] },
          '06': { name: 'Alpes-Maritimes', cities: ['Nice', 'Cannes', 'Antibes', 'Grasse', 'Menton'] },
          '07': { name: 'Ardèche', cities: ['Privas', 'Annonay', 'Aubenas', 'Tournon-sur-Rhône', 'Guilherand-Granges'] },
          '08': { name: 'Ardennes', cities: ['Charleville-Mézières', 'Sedan', 'Rethel', 'Givet', 'Revin'] },
          '09': { name: 'Ariège', cities: ['Foix', 'Pamiers', 'Saint-Girons', 'Lavelanet', 'Tarascon-sur-Ariège'] },
          '10': { name: 'Aube', cities: ['Troyes', 'Romilly-sur-Seine', 'La Chapelle-Saint-Luc', 'Saint-André-les-Vergers', 'Sainte-Savine'] },
          '11': { name: 'Aude', cities: ['Carcassonne', 'Narbonne', 'Castelnaudary', 'Limoux', 'Lézignan-Corbières'] },
          '12': { name: 'Aveyron', cities: ['Rodez', 'Millau', 'Villefranche-de-Rouergue', 'Decazeville', 'Onet-le-Château'] },
          '13': { name: 'Bouches-du-Rhône', cities: ['Marseille', 'Aix-en-Provence', 'Arles', 'Martigues', 'Aubagne'] },
          '14': { name: 'Calvados', cities: ['Caen', 'Hérouville-Saint-Clair', 'Lisieux', 'Bayeux', 'Vire'] },
          '15': { name: 'Cantal', cities: ['Aurillac', 'Saint-Flour', 'Mauriac', 'Arpajon-sur-Cère', 'Ytrac'] },
          '16': { name: 'Charente', cities: ['Angoulême', 'Cognac', 'Soyaux', 'La Couronne', 'Ruelle-sur-Touvre'] },
          '17': { name: 'Charente-Maritime', cities: ['La Rochelle', 'Rochefort', 'Saintes', 'Royan', 'Aytré'] },
          '18': { name: 'Cher', cities: ['Bourges', 'Vierzon', 'Saint-Amand-Montrond', 'Mehun-sur-Yèvre', 'Saint-Doulchard'] },
          '19': { name: 'Corrèze', cities: ['Tulle', 'Brive-la-Gaillarde', 'Ussel', 'Égletons', 'Malemort-sur-Corrèze'] },
          '21': { name: 'Côte-d\'Or', cities: ['Dijon', 'Beaune', 'Chenôve', 'Talant', 'Quetigny'] },
          '22': { name: 'Côtes-d\'Armor', cities: ['Saint-Brieuc', 'Lannion', 'Plérin', 'Lamballe', 'Dinan'] },
          '23': { name: 'Creuse', cities: ['Guéret', 'Aubusson', 'La Souterraine', 'Bourganeuf', 'Chambon-sur-Voueize'] },
          '24': { name: 'Dordogne', cities: ['Périgueux', 'Bergerac', 'Sarlat-la-Canéda', 'Coulounieix-Chamiers', 'Trélissac'] },
          '25': { name: 'Doubs', cities: ['Besançon', 'Montbéliard', 'Pontarlier', 'Audincourt', 'Valentigney'] },
          '26': { name: 'Drôme', cities: ['Valence', 'Romans-sur-Isère', 'Montélimar', 'Pierrelatte', 'Bourg-lès-Valence'] },
          '27': { name: 'Eure', cities: ['Évreux', 'Louviers', 'Vernon', 'Val-de-Reuil', 'Gisors'] },
          '28': { name: 'Eure-et-Loir', cities: ['Chartres', 'Dreux', 'Lucé', 'Châteaudun', 'Mainvilliers'] },
          '29': { name: 'Finistère', cities: ['Brest', 'Quimper', 'Concarneau', 'Morlaix', 'Douarnenez'] },
          '2A': { name: 'Corse-du-Sud', cities: ['Ajaccio', 'Porto-Vecchio', 'Propriano', 'Sartène', 'Bonifacio'] },
          '2B': { name: 'Haute-Corse', cities: ['Bastia', 'Corte', 'Calvi', 'L\'Île-Rousse', 'Biguglia'] },
          '30': { name: 'Gard', cities: ['Nîmes', 'Alès', 'Bagnols-sur-Cèze', 'Beaucaire', 'Saint-Gilles'] },
          '31': { name: 'Haute-Garonne', cities: ['Toulouse', 'Colomiers', 'Tournefeuille', 'Muret', 'Blagnac'] },
          '32': { name: 'Gers', cities: ['Auch', 'Condom', 'Fleurance', 'L\'Isle-Jourdain', 'Mirande'] },
          '33': { name: 'Gironde', cities: ['Bordeaux', 'Mérignac', 'Pessac', 'Talence', 'Villenave-d\'Ornon'] },
          '34': { name: 'Hérault', cities: ['Montpellier', 'Béziers', 'Sète', 'Lunel', 'Agde'] },
          '35': { name: 'Ille-et-Vilaine', cities: ['Rennes', 'Saint-Malo', 'Fougères', 'Vitré', 'Cesson-Sévigné'] },
          '36': { name: 'Indre', cities: ['Châteauroux', 'Issoudun', 'Le Blanc', 'La Châtre', 'Argenton-sur-Creuse'] },
          '37': { name: 'Indre-et-Loire', cities: ['Tours', 'Joué-lès-Tours', 'Saint-Pierre-des-Corps', 'Saint-Cyr-sur-Loire', 'Amboise'] },
          '38': { name: 'Isère', cities: ['Grenoble', 'Saint-Martin-d\'Hères', 'Vienne', 'Échirolles', 'Bourgoin-Jallieu'] },
          '39': { name: 'Jura', cities: ['Lons-le-Saunier', 'Dole', 'Saint-Claude', 'Champagnole', 'Morez'] },
          '40': { name: 'Landes', cities: ['Mont-de-Marsan', 'Dax', 'Biscarrosse', 'Saint-Paul-lès-Dax', 'Tarnos'] },
          '41': { name: 'Loir-et-Cher', cities: ['Blois', 'Romorantin-Lanthenay', 'Vendôme', 'Vineuil', 'Saint-Gervais-la-Forêt'] },
          '42': { name: 'Loire', cities: ['Saint-Étienne', 'Roanne', 'Saint-Chamond', 'Firminy', 'Montbrison'] },
          '43': { name: 'Haute-Loire', cities: ['Le Puy-en-Velay', 'Monistrol-sur-Loire', 'Yssingeaux', 'Brioude', 'Aurec-sur-Loire'] },
          '44': { name: 'Loire-Atlantique', cities: ['Nantes', 'Saint-Nazaire', 'Saint-Herblain', 'Rezé', 'Saint-Sébastien-sur-Loire'] },
          '45': { name: 'Loiret', cities: ['Orléans', 'Fleury-les-Aubrais', 'Olivet', 'Saint-Jean-de-Braye', 'Châlette-sur-Loing'] },
          '46': { name: 'Lot', cities: ['Cahors', 'Figeac', 'Gourdon', 'Souillac', 'Prayssac'] },
          '47': { name: 'Lot-et-Garonne', cities: ['Agen', 'Villeneuve-sur-Lot', 'Marmande', 'Le Passage', 'Nérac'] },
          '48': { name: 'Lozère', cities: ['Mende', 'Florac', 'Marvejols', 'Saint-Chély-d\'Apcher', 'Langogne'] },
          '49': { name: 'Maine-et-Loire', cities: ['Angers', 'Cholet', 'Saumur', 'Avrillé', 'Les Ponts-de-Cé'] },
          '50': { name: 'Manche', cities: ['Saint-Lô', 'Cherbourg-en-Cotentin', 'Équeurdreville-Hainneville', 'Tourlaville', 'Granville'] },
          '51': { name: 'Marne', cities: ['Reims', 'Châlons-en-Champagne', 'Épernay', 'Vitry-le-François', 'Tinqueux'] },
          '52': { name: 'Haute-Marne', cities: ['Chaumont', 'Saint-Dizier', 'Langres', 'Nogent', 'Joinville'] },
          '53': { name: 'Mayenne', cities: ['Laval', 'Mayenne', 'Château-Gontier', 'Évron', 'Changé'] },
          '54': { name: 'Meurthe-et-Moselle', cities: ['Nancy', 'Vandœuvre-lès-Nancy', 'Lunéville', 'Toul', 'Villers-lès-Nancy'] },
          '55': { name: 'Meuse', cities: ['Bar-le-Duc', 'Verdun', 'Commercy', 'Saint-Mihiel', 'Stenay'] },
          '56': { name: 'Morbihan', cities: ['Vannes', 'Lorient', 'Lanester', 'Ploemeur', 'Hennebont'] },
          '57': { name: 'Moselle', cities: ['Metz', 'Thionville', 'Montigny-lès-Metz', 'Forbach', 'Sarreguemines'] },
          '58': { name: 'Nièvre', cities: ['Nevers', 'Cosne-Cours-sur-Loire', 'Varennes-Vauzelles', 'Decize', 'La Charité-sur-Loire'] },
          '59': { name: 'Nord', cities: ['Lille', 'Tourcoing', 'Roubaix', 'Dunkerque', 'Villeneuve-d\'Ascq'] },
          '60': { name: 'Oise', cities: ['Beauvais', 'Compiègne', 'Creil', 'Senlis', 'Nogent-sur-Oise'] },
          '61': { name: 'Orne', cities: ['Alençon', 'Flers', 'Argentan', 'L\'Aigle', 'La Ferté-Macé'] },
          '62': { name: 'Pas-de-Calais', cities: ['Arras', 'Boulogne-sur-Mer', 'Calais', 'Lens', 'Liévin'] },
          '63': { name: 'Puy-de-Dôme', cities: ['Clermont-Ferrand', 'Riom', 'Cournon-d\'Auvergne', 'Chamalières', 'Issoire'] },
          '64': { name: 'Pyrénées-Atlantiques', cities: ['Pau', 'Bayonne', 'Anglet', 'Biarritz', 'Hendaye'] },
          '65': { name: 'Hautes-Pyrénées', cities: ['Tarbes', 'Lourdes', 'Bagnères-de-Bigorre', 'Aureilhan', 'Lannemezan'] },
          '66': { name: 'Pyrénées-Orientales', cities: ['Perpignan', 'Canet-en-Roussillon', 'Saint-Estève', 'Argelès-sur-Mer', 'Céret'] },
          '67': { name: 'Bas-Rhin', cities: ['Strasbourg', 'Haguenau', 'Schiltigheim', 'Illkirch-Graffenstaden', 'Sélestat'] },
          '68': { name: 'Haut-Rhin', cities: ['Mulhouse', 'Colmar', 'Saint-Louis', 'Wittenheim', 'Illzach'] },
          '69': { name: 'Rhône', cities: ['Lyon', 'Villeurbanne', 'Vénissieux', 'Caluire-et-Cuire', 'Saint-Priest'] },
          '70': { name: 'Haute-Saône', cities: ['Vesoul', 'Luxeuil-les-Bains', 'Héricourt', 'Lure', 'Gray'] },
          '71': { name: 'Saône-et-Loire', cities: ['Mâcon', 'Chalon-sur-Saône', 'Le Creusot', 'Montceau-les-Mines', 'Autun'] },
          '72': { name: 'Sarthe', cities: ['Le Mans', 'Sablé-sur-Sarthe', 'Allonnes', 'La Flèche', 'Coulaines'] },
          '73': { name: 'Savoie', cities: ['Chambéry', 'Aix-les-Bains', 'Albertville', 'Saint-Jean-de-Maurienne', 'Montmélian'] },
          '74': { name: 'Haute-Savoie', cities: ['Annecy', 'Thonon-les-Bains', 'Annemasse', 'Cluses', 'Évian-les-Bains'] },
          '75': { name: 'Paris', cities: ['Paris'] },
          '76': { name: 'Seine-Maritime', cities: ['Rouen', 'Le Havre', 'Dieppe', 'Sotteville-lès-Rouen', 'Saint-Étienne-du-Rouvray'] },
          '77': { name: 'Seine-et-Marne', cities: ['Meaux', 'Melun', 'Chelles', 'Pontault-Combault', 'Savigny-le-Temple'] },
          '78': { name: 'Yvelines', cities: ['Versailles', 'Sartrouville', 'Mantes-la-Jolie', 'Saint-Germain-en-Laye', 'Poissy'] },
          '79': { name: 'Deux-Sèvres', cities: ['Niort', 'Bressuire', 'Thouars', 'Parthenay', 'Saint-Maixent-l\'École'] },
          '80': { name: 'Somme', cities: ['Amiens', 'Abbeville', 'Albert', 'Péronne', 'Montdidier'] },
          '81': { name: 'Tarn', cities: ['Albi', 'Castres', 'Gaillac', 'Graulhet', 'Mazamet'] },
          '82': { name: 'Tarn-et-Garonne', cities: ['Montauban', 'Castelsarrasin', 'Moissac', 'Caussade', 'Valence'] },
          '83': { name: 'Var', cities: ['Toulon', 'La Seyne-sur-Mer', 'Hyères', 'Fréjus', 'Draguignan'] },
          '84': { name: 'Vaucluse', cities: ['Avignon', 'Carpentras', 'Orange', 'Cavaillon', 'Apt'] },
          '85': { name: 'Vendée', cities: ['La Roche-sur-Yon', 'Les Sables-d\'Olonne', 'Challans', 'Fontenay-le-Comte', 'Luçon'] },
          '86': { name: 'Vienne', cities: ['Poitiers', 'Châtellerault', 'Buxerolles', 'Loudun', 'Saint-Benoît'] },
          '87': { name: 'Haute-Vienne', cities: ['Limoges', 'Saint-Junien', 'Panazol', 'Couzeix', 'Le Palais-sur-Vienne'] },
          '88': { name: 'Vosges', cities: ['Épinal', 'Saint-Dié-des-Vosges', 'Gérardmer', 'Remiremont', 'Golbey'] },
          '89': { name: 'Yonne', cities: ['Auxerre', 'Sens', 'Joigny', 'Avallon', 'Migennes'] },
          '90': { name: 'Territoire de Belfort', cities: ['Belfort', 'Delle', 'Valdoie', 'Beaucourt', 'Danjoutin'] },
          '91': { name: 'Essonne', cities: ['Évry-Courcouronnes', 'Corbeil-Essonnes', 'Massy', 'Savigny-sur-Orge', 'Sainte-Geneviève-des-Bois'] },
          '92': { name: 'Hauts-de-Seine', cities: ['Nanterre', 'Boulogne-Billancourt', 'Colombes', 'Asnières-sur-Seine', 'Courbevoie'] },
          '93': { name: 'Seine-Saint-Denis', cities: ['Bobigny', 'Saint-Denis', 'Montreuil', 'Aubervilliers', 'Aulnay-sous-Bois'] },
          '94': { name: 'Val-de-Marne', cities: ['Créteil', 'Vitry-sur-Seine', 'Champigny-sur-Marne', 'Saint-Maur-des-Fossés', 'Ivry-sur-Seine'] },
          '95': { name: 'Val-d\'Oise', cities: ['Cergy', 'Argenteuil', 'Sarcelles', 'Garges-lès-Gonesse', 'Franconville'] }
        };

        const VISIT_LEVELS = {
          never: { label: 'Jamais allé', color: '#d1d5db', emoji: '⚪' },
          passed: { label: 'Déjà passé', color: '#f59e0b', emoji: '🟡' },
          ate: { label: 'Déjà mangé', color: '#10b981', emoji: '🟢' },
          slept: { label: 'Déjà dormi', color: '#8b5cf6', emoji: '🟣' }
        };

        const REGIONS = {
          'Auvergne-Rhône-Alpes': ['01', '03', '07', '15', '26', '38', '42', '43', '63', '69', '73', '74'],
          'Bourgogne-Franche-Comté': ['21', '25', '39', '58', '70', '71', '89', '90'],
          'Bretagne': ['22', '29', '35', '56'],
          'Centre-Val de Loire': ['18', '28', '36', '37', '41', '45'],
          'Corse': ['2A', '2B'],
          'Grand Est': ['08', '10', '51', '52', '54', '55', '57', '67', '68', '88'],
          'Hauts-de-France': ['02', '59', '60', '62', '80'],
          'Île-de-France': ['75', '77', '78', '91', '92', '93', '94', '95'],
          'Normandie': ['14', '27', '50', '61', '76'],
          'Nouvelle-Aquitaine': ['16', '17', '19', '23', '24', '33', '40', '47', '64', '79', '86', '87'],
          'Occitanie': ['09', '11', '12', '30', '31', '32', '34', '46', '48', '65', '66', '81', '82'],
          'Pays de la Loire': ['44', '49', '53', '72', '85'],
          'Provence-Alpes-Côte d\'Azur': ['04', '05', '06', '13', '83', '84']
        };

        const REGION_COLORS = {
          'Auvergne-Rhône-Alpes': { r: 52, g: 152, b: 219 },      // Bleu
          'Bourgogne-Franche-Comté': { r: 155, g: 89, b: 182 },   // Violet
          'Bretagne': { r: 46, g: 204, b: 113 },                  // Vert
          'Centre-Val de Loire': { r: 241, g: 196, b: 15 },       // Jaune
          'Corse': { r: 230, g: 126, b: 34 },                     // Orange
          'Grand Est': { r: 231, g: 76, b: 60 },                  // Rouge
          'Hauts-de-France': { r: 52, g: 73, b: 94 },             // Bleu foncé
          'Île-de-France': { r: 149, g: 165, b: 166 },            // Gris
          'Normandie': { r: 26, g: 188, b: 156 },                 // Turquoise
          'Nouvelle-Aquitaine': { r: 142, g: 68, b: 173 },        // Pourpre
          'Occitanie': { r: 243, g: 156, b: 18 },                 // Orange doré
          'Pays de la Loire': { r: 22, g: 160, b: 133 },          // Vert sarcelle
          'Provence-Alpes-Côte d\'Azur': { r: 211, g: 84, b: 0 }  // Orange brûlé
        };

        // Helper function to get region for a department
        const getDepartmentRegion = (code) => {
          for (const [region, depts] of Object.entries(REGIONS)) {
            if (depts.includes(code)) return region;
          }
          return null;
        };

        // Helper function to calculate color with opacity based on max visit level
        const getDepartmentColor = (code, state) => {
          const region = getDepartmentRegion(code);
          if (!region || !REGION_COLORS[region]) {
            return 'rgba(204, 204, 204, 0.3)'; // Fallback color with transparency
          }

          const baseColor = REGION_COLORS[region];

          // Find the maximum visit level in this department
          const cityVisits = state?.cityVisits || {};
          const visitLevels = Object.values(cityVisits);

          let maxLevel = 'never';
          if (visitLevels.includes('slept')) {
            maxLevel = 'slept';
          } else if (visitLevels.includes('ate')) {
            maxLevel = 'ate';
          } else if (visitLevels.includes('passed')) {
            maxLevel = 'passed';
          }

          // Opacity based on max level: slept=1.0, ate=0.75, passed=0.5, never=0.3
          let opacity = 0.3;
          let colorIntensity = 0;

          if (maxLevel === 'slept') {
            opacity = 1.0;
            colorIntensity = 1.0;
          } else if (maxLevel === 'ate') {
            opacity = 0.75;
            colorIntensity = 0.7;
          } else if (maxLevel === 'passed') {
            opacity = 0.5;
            colorIntensity = 0.4;
          }

          // Color intensity based on max level
          const lightness = 0.7 * (1 - colorIntensity);
          const r = Math.round(baseColor.r + (255 - baseColor.r) * lightness);
          const g = Math.round(baseColor.g + (255 - baseColor.g) * lightness);
          const b = Math.round(baseColor.b + (255 - baseColor.b) * lightness);

          return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        };

        function FranceMap() {
          const [geoData, setGeoData] = useState(null);
          const [loading, setLoading] = useState(true);
          const [appState, setAppState] = useState(() => {
            const saved = localStorage.getItem('franceMapCityVisits');
            if (saved) return JSON.parse(saved);

            // Initialize state with cityVisits for each department
            const initialState = {};
            Object.keys(departmentInfo).forEach(code => {
              initialState[code] = {
                cityVisits: {} // { cityName: 'never' | 'passed' | 'ate' | 'slept' }
              };
            });
            return initialState;
          });

          useEffect(() => {
            localStorage.setItem('franceMapCityVisits', JSON.stringify(appState));
          }, [appState]);

          const [modalOpen, setModalOpen] = useState(false);
          const [currentDepartment, setCurrentDepartment] = useState(null);
          const [activeTab, setActiveTab] = useState('map');
          const [mapZoom, setMapZoom] = useState(1);
          const [mapPan, setMapPan] = useState({ x: 0, y: 0 });

          useEffect(() => {
            fetch(GEOJSON_URL)
              .then(res => res.json())
              .then(data => {
                setGeoData(data);
                setLoading(false);
              })
              .catch(err => {
                console.error('Erreur chargement GeoJSON:', err);
                setLoading(false);
              });
          }, []);

          const openModal = (code) => {
            setCurrentDepartment(code);
            setModalOpen(true);
          };

          const closeModal = () => {
            setModalOpen(false);
            setCurrentDepartment(null);
          };

          const updateCityVisit = (departmentCode, cityName, visitLevel) => {
            setAppState(prev => ({
              ...prev,
              [departmentCode]: {
                ...prev[departmentCode],
                cityVisits: {
                  ...prev[departmentCode].cityVisits,
                  [cityName]: visitLevel
                }
              }
            }));
          };

          // Export/Import functions
          const handleExport = () => {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `france-map-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
          };

          const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const imported = JSON.parse(e.target.result);
                setAppState(imported);
                alert('✅ Données importées avec succès !');
              } catch (error) {
                alert('❌ Erreur lors de l\'import : fichier invalide');
                console.error(error);
              }
            };
            reader.readAsText(file);
          };

          // Calculate statistics
          const calculateStats = () => {
            // Count TOTAL available cities from departmentInfo
            let totalCitiesAvailable = 0;
            Object.values(departmentInfo).forEach(dept => {
              totalCitiesAvailable += dept.cities.filter(city => CITY_COORDINATES[city]).length;
            });

            let visitedCities = 0;
            let passedCities = 0;
            let ateCities = 0;
            let sleptCities = 0;

            // Count visited cities from appState
            Object.entries(appState).forEach(([code, deptState]) => {
              if (deptState.cityVisits) {
                Object.values(deptState.cityVisits).forEach(level => {
                  if (level !== 'never') visitedCities++;
                  if (level === 'passed') passedCities++;
                  if (level === 'ate') ateCities++;
                  if (level === 'slept') sleptCities++;
                });
              }
            });

            // Departments with at least one visit
            const deptsWithVisits = Object.entries(appState).filter(([code, state]) => {
              if (!state.cityVisits) return false;
              return Object.values(state.cityVisits).some(level => level !== 'never');
            }).length;

            // Stats by region
            const regionStats = {};
            Object.entries(REGIONS).forEach(([region, depts]) => {
              let visitedInRegion = 0;
              let totalInRegion = 0;

              depts.forEach(code => {
                // Count total available cities in this department
                const deptInfo = departmentInfo[code];
                if (deptInfo) {
                  totalInRegion += deptInfo.cities.filter(city => CITY_COORDINATES[city]).length;
                }

                // Count visited cities
                const state = appState[code];
                if (state && state.cityVisits) {
                  Object.values(state.cityVisits).forEach(level => {
                    if (level !== 'never') visitedInRegion++;
                  });
                }
              });

              regionStats[region] = {
                visited: visitedInRegion,
                total: totalInRegion,
                percent: totalInRegion > 0 ? Math.round((visitedInRegion / totalInRegion) * 100) : 0
              };
            });

            return {
              totalCities: totalCitiesAvailable,
              visitedCities,
              passedCities,
              ateCities,
              sleptCities,
              deptsWithVisits,
              percentVisited: totalCitiesAvailable > 0 ? Math.round((visitedCities / totalCitiesAvailable) * 100) : 0,
              regionStats
            };
          };

          const stats = calculateStats();

          const convertToSVGPath = (coordinates, bounds) => {
            const paths = [];
            
            const projectPoint = ([lon, lat]) => {
              const x = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * 1000;
              const y = ((bounds.maxLat - lat) / (bounds.maxLat - bounds.minLat)) * 1100;
              return [x, y];
            };

            const processRing = (ring) => {
              const projected = ring.map(projectPoint);
              return 'M ' + projected.map(p => p.join(',')).join(' L ') + ' Z';
            };

            if (coordinates[0] && Array.isArray(coordinates[0][0]) && Array.isArray(coordinates[0][0][0])) {
              coordinates.forEach(polygon => {
                polygon.forEach(ring => {
                  paths.push(processRing(ring));
                });
              });
            } else if (coordinates[0] && Array.isArray(coordinates[0][0])) {
              coordinates.forEach(ring => {
                paths.push(processRing(ring));
              });
            }

            return paths.join(' ');
          };

          const getBounds = (departmentCode = null) => {
            if (!geoData) return null;

            let minLon = Infinity, maxLon = -Infinity;
            let minLat = Infinity, maxLat = -Infinity;

            const processCoords = (c) => {
              if (Array.isArray(c[0])) {
                c.forEach(processCoords);
              } else {
                const [lon, lat] = c;
                minLon = Math.min(minLon, lon);
                maxLon = Math.max(maxLon, lon);
                minLat = Math.min(minLat, lat);
                maxLat = Math.max(maxLat, lat);
              }
            };

            if (departmentCode) {
              // Get bounds for specific department
              const feature = geoData.features.find(f => f.properties.code === departmentCode);
              if (feature) {
                processCoords(feature.geometry.coordinates);
              }
            } else {
              // Get bounds for all of France
              geoData.features.forEach(feature => {
                processCoords(feature.geometry.coordinates);
              });
            }

            return { minLon, maxLon, minLat, maxLat };
          };

          if (loading) {
            return (
              <div className="flex items-center justify-center min-h-screen">
                <div className="text-2xl text-gray-600">Chargement de la carte...</div>
              </div>
            );
          }

          if (!geoData) {
            return (
              <div className="flex items-center justify-center min-h-screen">
                <div className="text-xl text-red-600">Erreur de chargement de la carte</div>
              </div>
            );
          }

          const bounds = getBounds();

          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
              <div className="p-4 md:p-8">
                <div className="max-w-[1600px] mx-auto">
                  {/* Navigation Tabs */}
                  {!currentDepartment && (
                    <div className="mb-6">
                      <div className="flex gap-2 bg-white rounded-lg p-2 shadow-md">
                        <TabButton active={activeTab === 'map'} onClick={() => setActiveTab('map')}>
                          🗺️ Carte
                        </TabButton>
                        <TabButton active={activeTab === 'stats'} onClick={() => setActiveTab('stats')}>
                          📊 Statistiques
                        </TabButton>
                        <div className="flex-1"></div>
                        <button
                          onClick={handleExport}
                          className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-semibold"
                        >
                          📥 Export
                        </button>
                        <label className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm font-semibold cursor-pointer">
                          📤 Import
                          <input
                            type="file"
                            accept=".json"
                            onChange={handleImport}
                            className="hidden"
                          />
                        </label>
                      </div>
                    </div>
                  )}

                  {/* Content based on active tab */}
                  {!currentDepartment && activeTab === 'map' && (
                    <MapView
                      geoData={geoData}
                      bounds={bounds}
                      appState={appState}
                      convertToSVGPath={convertToSVGPath}
                      openModal={openModal}
                      mapZoom={mapZoom}
                      setMapZoom={setMapZoom}
                      mapPan={mapPan}
                      setMapPan={setMapPan}
                      getDepartmentColor={getDepartmentColor}
                    />
                  )}

                  {!currentDepartment && activeTab === 'stats' && (
                    <StatsView stats={stats} appState={appState} />
                  )}
                </div>
              </div>

              {modalOpen && currentDepartment && (
                <DepartmentOverlay
                  code={currentDepartment}
                  department={departmentInfo[currentDepartment]}
                  state={appState[currentDepartment]}
                  onClose={closeModal}
                  onUpdateCityVisit={updateCityVisit}
                  geoData={geoData}
                  bounds={bounds}
                  getBounds={getBounds}
                  convertToSVGPath={convertToSVGPath}
                  getDepartmentColor={getDepartmentColor}
                />
              )}
            </div>
          );
        }

        function TabButton({ active, onClick, children }) {
          return (
            <button
              onClick={onClick}
              className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                active 
                  ? 'bg-blue-500 text-white border-b-4 border-blue-700' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              {children}
            </button>
          );
        }

        function MapView({ geoData, bounds, appState, convertToSVGPath, openModal, mapZoom, setMapZoom, mapPan, setMapPan, getDepartmentColor }) {
          const svgRef = React.useRef(null);
          const [tooltip, setTooltip] = useState({ visible: false, name: '', x: 0, y: 0 });

          React.useEffect(() => {
            const svg = svgRef.current;
            if (!svg) return;

            const handleWheel = (e) => {
              e.preventDefault();
              const delta = e.deltaY > 0 ? 0.9 : 1.1;
              setMapZoom(prev => Math.max(1, Math.min(5, prev * delta)));
            };

            svg.addEventListener('wheel', handleWheel, { passive: false });
            return () => svg.removeEventListener('wheel', handleWheel);
          }, [setMapZoom]);

          const handleReset = () => {
            setMapZoom(1);
            setMapPan({ x: 0, y: 0 });
          };

          const handleDepartmentMouseEnter = (e, code) => {
            const deptName = departmentInfo[code]?.name;
            setTooltip({
              visible: true,
              name: `${deptName} (${code})`,
              x: e.clientX,
              y: e.clientY
            });
          };

          const handleDepartmentMouseMove = (e) => {
            setTooltip(prev => ({
              ...prev,
              x: e.clientX,
              y: e.clientY
            }));
          };

          const handleDepartmentMouseLeave = () => {
            setTooltip({ visible: false, name: '', x: 0, y: 0 });
          };

          return (
            <>
              <header className="text-center mb-10">
                <h1 className="text-5xl md:text-6xl font-bold text-gray-800 mb-3">
                  🗺️ Carte Interactive de France
                </h1>
                <p className="text-lg text-gray-600">
                  Explorez les départements français · Cliquez pour agrandir
                </p>
              </header>

              <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-10 mb-8 map-container">
                {mapZoom > 1 && (
                  <div className="mb-4 flex items-center gap-4">
                    <button
                      onClick={handleReset}
                      className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                    >
                      Réinitialiser le zoom
                    </button>
                    <span className="text-sm text-gray-600">Zoom: {mapZoom.toFixed(1)}x</span>
                  </div>
                )}
                <svg
                  ref={svgRef}
                  viewBox="0 0 1000 1100"
                  className="w-full h-auto"
                  style={{ minHeight: '600px', cursor: mapZoom > 1 ? 'grab' : 'default' }}
                >
                  <defs>
                    {/* Gradient for water/ocean effect */}
                    <linearGradient id="oceanGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style={{ stopColor: '#e0f2fe', stopOpacity: 1 }} />
                      <stop offset="100%" style={{ stopColor: '#bae6fd', stopOpacity: 1 }} />
                    </linearGradient>
                    {/* Shadow filter */}
                    <filter id="departmentShadow" x="-50%" y="-50%" width="200%" height="200%">
                      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                      <feOffset dx="0" dy="1" result="offsetblur"/>
                      <feComponentTransfer>
                        <feFuncA type="linear" slope="0.3"/>
                      </feComponentTransfer>
                      <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>
                  </defs>
                  
                  {/* Ocean background */}
                  <rect x="0" y="0" width="1000" height="1100" fill="url(#oceanGradient)" opacity="0.3"/>

                  <g transform={`translate(${500 - 500 * mapZoom + mapPan.x}, ${550 - 550 * mapZoom + mapPan.y}) scale(${mapZoom})`}>
                  <g id="departments">
                    {geoData.features.map(feature => {
                      const code = feature.properties.code;
                      const path = convertToSVGPath(feature.geometry.coordinates, bounds);
                      const state = appState[code];

                      return (
                        <g key={code}>
                          <path
                            d={path}
                            fill={getDepartmentColor(code, state)}
                            stroke="#fff"
                            strokeWidth="2"
                            className="department-path"
                            filter="url(#departmentShadow)"
                            onClick={() => openModal(code)}
                            onMouseEnter={(e) => handleDepartmentMouseEnter(e, code)}
                            onMouseMove={handleDepartmentMouseMove}
                            onMouseLeave={handleDepartmentMouseLeave}
                          />
                        </g>
                      );
                    })}
                  </g>

                  {/* City markers on main map */}
                  <g id="city-markers-main">
                    {Object.entries(appState).map(([deptCode, deptState]) => {
                      if (!deptState.cityVisits) return null;

                      return Object.entries(deptState.cityVisits).map(([cityName, visitLevel]) => {
                        if (visitLevel === 'never' || !CITY_COORDINATES[cityName]) return null;

                        const [lon, lat] = CITY_COORDINATES[cityName];
                        const cityX = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * 1000;
                        const cityY = ((bounds.maxLat - lat) / (bounds.maxLat - bounds.minLat)) * 1100;
                        const levelColor = VISIT_LEVELS[visitLevel].color;

                        return (
                          <g key={`${deptCode}-${cityName}`}>
                            <circle
                              cx={cityX}
                              cy={cityY}
                              r="4"
                              fill={levelColor}
                              stroke="#fff"
                              strokeWidth="1.5"
                              opacity="0.9"
                            />
                            <title>{cityName} - {VISIT_LEVELS[visitLevel].label}</title>
                          </g>
                        );
                      });
                    })}
                  </g>
                  </g>

                  {/* Mini Île-de-France inset map */}
                  {(() => {
                    const idfDepts = ['75', '77', '78', '91', '92', '93', '94', '95'];

                    // Calculate bounds for Île-de-France only
                    let idfMinLon = Infinity, idfMaxLon = -Infinity;
                    let idfMinLat = Infinity, idfMaxLat = -Infinity;

                    const idfFeatures = geoData.features.filter(f => idfDepts.includes(f.properties.code));

                    const processIdfCoords = (c) => {
                      if (Array.isArray(c[0])) {
                        c.forEach(processIdfCoords);
                      } else {
                        const [lon, lat] = c;
                        idfMinLon = Math.min(idfMinLon, lon);
                        idfMaxLon = Math.max(idfMaxLon, lon);
                        idfMinLat = Math.min(idfMinLat, lat);
                        idfMaxLat = Math.max(idfMaxLat, lat);
                      }
                    };

                    idfFeatures.forEach(feature => {
                      processIdfCoords(feature.geometry.coordinates);
                    });

                    // Add padding
                    const lonPadding = (idfMaxLon - idfMinLon) * 0.1;
                    const latPadding = (idfMaxLat - idfMinLat) * 0.1;
                    const idfBounds = {
                      minLon: idfMinLon - lonPadding,
                      maxLon: idfMaxLon + lonPadding,
                      minLat: idfMinLat - latPadding,
                      maxLat: idfMaxLat + latPadding
                    };

                    // Inset position and size (top-left corner)
                    const insetX = 20;
                    const insetY = 20;
                    const insetWidth = 200;
                    const insetHeight = 180;

                    return (
                      <g id="idf-inset">
                        {/* Title with semi-transparent background */}
                        <text
                          x={insetX + insetWidth / 2}
                          y={insetY + 12}
                          textAnchor="middle"
                          style={{
                            fontSize: '12px',
                            fontWeight: 'bold',
                            fill: '#1f2937',
                            textShadow: '0 0 4px white, 0 0 8px white, 0 0 12px white'
                          }}
                        >
                          Île-de-France
                        </text>

                        {/* Departments in IDF */}
                        <g transform={`translate(${insetX}, ${insetY + 20})`}>
                          <svg viewBox="0 0 1000 1100" width={insetWidth} height={insetHeight - 20}>
                            {/* Semi-transparent background behind the map */}
                            <rect
                              x="0"
                              y="0"
                              width="1000"
                              height="1100"
                              fill="white"
                              opacity="0.3"
                            />

                            {idfFeatures.map(feature => {
                              const code = feature.properties.code;
                              const path = convertToSVGPath(feature.geometry.coordinates, idfBounds);
                              const state = appState[code];

                              return (
                                <g key={`idf-${code}`}>
                                  <path
                                    d={path}
                                    fill={getDepartmentColor(code, state)}
                                    stroke="#333"
                                    strokeWidth="5"
                                    style={{ cursor: 'pointer', filter: 'drop-shadow(0px 2px 3px rgba(0,0,0,0.3))' }}
                                    onClick={() => openModal(code)}
                                  />
                                  {/* Department number label */}
                                  {(() => {
                                    // Calculate centroid for label placement
                                    const coords = feature.geometry.coordinates;
                                    let sumLon = 0, sumLat = 0, count = 0;

                                    const sumCoords = (c) => {
                                      if (Array.isArray(c[0])) {
                                        c.forEach(sumCoords);
                                      } else {
                                        sumLon += c[0];
                                        sumLat += c[1];
                                        count++;
                                      }
                                    };

                                    sumCoords(coords);

                                    if (count > 0) {
                                      const centroidLon = sumLon / count;
                                      const centroidLat = sumLat / count;
                                      const labelX = ((centroidLon - idfBounds.minLon) / (idfBounds.maxLon - idfBounds.minLon)) * 1000;
                                      const labelY = ((idfBounds.maxLat - centroidLat) / (idfBounds.maxLat - idfBounds.minLat)) * 1100;

                                      return (
                                        <text
                                          x={labelX}
                                          y={labelY}
                                          textAnchor="middle"
                                          dominantBaseline="middle"
                                          style={{
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            fill: '#1f2937',
                                            textShadow: '0 0 3px white, 0 0 6px white',
                                            pointerEvents: 'none'
                                          }}
                                        >
                                          {code}
                                        </text>
                                      );
                                    }
                                    return null;
                                  })()}
                                </g>
                              );
                            })}

                            {/* City markers in IDF inset */}
                            {Object.entries(appState)
                              .filter(([deptCode]) => idfDepts.includes(deptCode))
                              .map(([deptCode, deptState]) => {
                                if (!deptState.cityVisits) return null;

                                return Object.entries(deptState.cityVisits).map(([cityName, visitLevel]) => {
                                  if (visitLevel === 'never' || !CITY_COORDINATES[cityName]) return null;

                                  const [lon, lat] = CITY_COORDINATES[cityName];
                                  const cityX = ((lon - idfBounds.minLon) / (idfBounds.maxLon - idfBounds.minLon)) * 1000;
                                  const cityY = ((idfBounds.maxLat - lat) / (idfBounds.maxLat - idfBounds.minLat)) * 1100;
                                  const levelColor = VISIT_LEVELS[visitLevel].color;

                                  return (
                                    <g key={`idf-city-${deptCode}-${cityName}`}>
                                      <circle
                                        cx={cityX}
                                        cy={cityY}
                                        r="6"
                                        fill={levelColor}
                                        stroke="#fff"
                                        strokeWidth="2"
                                        opacity="0.9"
                                      />
                                      <title>{cityName} - {VISIT_LEVELS[visitLevel].label}</title>
                                    </g>
                                  );
                                });
                              })}
                          </svg>
                        </g>
                      </g>
                    );
                  })()}
                </svg>

                {/* Tooltip */}
                {tooltip.visible && (
                  <div
                    className="department-tooltip"
                    style={{
                      left: `${tooltip.x + 15}px`,
                      top: `${tooltip.y + 15}px`
                    }}
                  >
                    {tooltip.name}
                  </div>
                )}

                <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                  <h3 className="font-semibold text-gray-800 mb-3">Légende</h3>
                  <div className="space-y-4">
                    {/* Visit levels */}
                    <div>
                      <p className="text-sm font-medium text-gray-700 mb-2">Niveaux de visite :</p>
                      <div className="flex flex-wrap gap-3">
                        {Object.entries(VISIT_LEVELS).map(([level, { label, emoji, color }]) => (
                          <div key={level} className="flex items-center gap-2">
                            <div
                              className="w-5 h-5 rounded-full border-2 border-white shadow"
                              style={{ backgroundColor: color }}
                            />
                            <span className="text-xs text-gray-600">{emoji} {label}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Region colors */}
                    <div>
                      <p className="text-sm font-medium text-gray-700 mb-2">Couleurs par région :</p>
                      <div className="flex flex-wrap gap-3">
                        {Object.entries(REGION_COLORS).map(([region, color]) => (
                          <div key={region} className="flex items-center gap-2">
                            <div
                              className="w-6 h-6 rounded border border-gray-300"
                              style={{ backgroundColor: `rgb(${color.r}, ${color.g}, ${color.b})` }}
                            />
                            <span className="text-xs text-gray-600">{region}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Intensity explanation */}
                    <div>
                      <p className="text-sm font-medium text-gray-700 mb-2">Intensité de couleur :</p>
                      <div className="flex items-center gap-2">
                        <div className="flex items-center gap-1">
                          <div className="w-8 h-6 rounded border border-gray-300" style={{ backgroundColor: 'rgb(230, 230, 250)' }} />
                          <span className="text-xs text-gray-600">0%</span>
                        </div>
                        <span className="text-gray-400">→</span>
                        <div className="flex items-center gap-1">
                          <div className="w-8 h-6 rounded border border-gray-300" style={{ backgroundColor: 'rgb(52, 152, 219)' }} />
                          <span className="text-xs text-gray-600">100%</span>
                        </div>
                        <span className="text-xs text-gray-500 ml-2">(% villes visitées)</span>
                      </div>
                    </div>

                    {/* City markers */}
                    <div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-red-500 border-2 border-white" />
                        <span className="text-sm text-gray-600">Villes visitées</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </>
          );
        }

        function StatsView({ stats, appState }) {
          // Sort regions by completion percentage
          const sortedRegions = Object.entries(stats.regionStats)
            .sort((a, b) => b[1].percent - a[1].percent);

          return (
            <div className="space-y-8">
              <header className="text-center">
                <h1 className="text-5xl md:text-6xl font-bold text-gray-800 mb-3">
                  📊 Statistiques de Découverte
                </h1>
                <p className="text-lg text-gray-600">
                  Votre progression à travers la France
                </p>
              </header>

              {/* Main Stats Cards */}
              <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <StatCard
                  title="Villes visitées"
                  value={`${stats.visitedCities}/${stats.totalCities}`}
                  subtitle={`${stats.percentVisited}% du total`}
                  icon="🏙️"
                />
                <StatCard
                  title="Départements explorés"
                  value={`${stats.deptsWithVisits}/96`}
                  subtitle={`${Math.round((stats.deptsWithVisits / 96) * 100)}% de la France`}
                  icon="🗺️"
                />
                <StatCard
                  title="Villes dormies"
                  value={stats.sleptCities}
                  subtitle="Nuits passées 🟣"
                  icon="🌙"
                />
                <StatCard
                  title="Villes repas"
                  value={stats.ateCities}
                  subtitle="Repas pris 🟢"
                  icon="🍽️"
                />
              </div>

              {/* Visit Level Breakdown */}
              <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <h3 className="text-2xl font-bold text-gray-800 mb-6">Répartition par niveau de visite</h3>
                <div className="grid md:grid-cols-4 gap-4">
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <div className="text-4xl mb-2">⚪</div>
                    <div className="text-3xl font-bold text-gray-700">{stats.totalCities - stats.visitedCities}</div>
                    <div className="text-sm text-gray-600">Jamais allé</div>
                  </div>
                  <div className="text-center p-4 bg-orange-50 rounded-lg">
                    <div className="text-4xl mb-2">🟡</div>
                    <div className="text-3xl font-bold text-orange-600">{stats.passedCities}</div>
                    <div className="text-sm text-gray-600">Déjà passé</div>
                  </div>
                  <div className="text-center p-4 bg-green-50 rounded-lg">
                    <div className="text-4xl mb-2">🟢</div>
                    <div className="text-3xl font-bold text-green-600">{stats.ateCities}</div>
                    <div className="text-sm text-gray-600">Déjà mangé</div>
                  </div>
                  <div className="text-center p-4 bg-purple-50 rounded-lg">
                    <div className="text-4xl mb-2">🟣</div>
                    <div className="text-3xl font-bold text-purple-600">{stats.sleptCities}</div>
                    <div className="text-sm text-gray-600">Déjà dormi</div>
                  </div>
                </div>
              </div>

              {/* Regional Progress */}
              <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <h3 className="text-2xl font-bold text-gray-800 mb-6">Progression par région</h3>
                <div className="space-y-4">
                  {sortedRegions.map(([region, data]) => (
                    <div key={region}>
                      <div className="flex justify-between text-sm mb-2">
                        <span className="font-semibold text-gray-700">{region}</span>
                        <span className="text-gray-600">
                          {data.visited}/{data.total} villes ({data.percent}%)
                        </span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-3">
                        <div
                          className={`h-3 rounded-full transition-all ${
                            data.percent === 100 ? 'bg-green-500' :
                            data.percent >= 75 ? 'bg-blue-500' :
                            data.percent >= 50 ? 'bg-yellow-500' :
                            data.percent >= 25 ? 'bg-orange-500' : 'bg-red-400'
                          }`}
                          style={{ width: `${data.percent}%` }}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Export/Import reminder */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 text-center">
                <h3 className="text-xl font-bold text-blue-900 mb-2">💾 Sauvegardez vos données</h3>
                <p className="text-blue-700 mb-4">
                  N'oubliez pas d'exporter régulièrement vos données pour ne pas les perdre !
                </p>
                <p className="text-sm text-blue-600">
                  Utilisez les boutons Export/Import en haut de la page
                </p>
              </div>
            </div>
          );
        }

        function StatItem({ number, label, sublabel }) {
          return (
            <div className="text-center">
              <div className="text-2xl md:text-3xl font-bold text-blue-600">{number}</div>
              <div className="text-xs md:text-sm text-gray-600">{label}</div>
              {sublabel && <div className="text-xs text-gray-500">{sublabel}</div>}
            </div>
          );
        }

        function StatCard({ title, value, subtitle, icon }) {
          return (
            <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-sm font-semibold text-gray-600 uppercase">{title}</h3>
                {icon && <span className="text-3xl">{icon}</span>}
              </div>
              <div className="text-4xl font-bold text-gray-800 mb-1">{value}</div>
              {subtitle && <p className="text-sm text-gray-500">{subtitle}</p>}
            </div>
          );
        }

        function DepartmentOverlay({ code, department, state, onClose, onUpdateCityVisit, geoData, bounds, getBounds, convertToSVGPath, getDepartmentColor }) {
          // Get all cities that have GPS coordinates
          const allAvailableCities = department.cities.filter(city => CITY_COORDINATES[city]);
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedCity, setSelectedCity] = useState(null);

          // Filter cities based on search
          const filteredCities = searchTerm
            ? allAvailableCities.filter(city =>
                city.toLowerCase().includes(searchTerm.toLowerCase())
              )
            : allAvailableCities;

          const getCityVisitLevel = (cityName) => {
            return state?.cityVisits?.[cityName] || 'never';
          };

          const handleCityClick = (cityName) => {
            setSelectedCity(cityName);
          };

          const handleSetVisitLevel = (cityName, level) => {
            onUpdateCityVisit(code, cityName, level);
            setSelectedCity(null);
          };

          // Get department bounding box for zoomed view
          const departmentFeature = geoData.features.find(f => f.properties.code === code);
          if (!departmentFeature) return null;

          // Calculate zoomed bounds for this department
          const deptBounds = getBounds(code);
          if (!deptBounds) return null;

          // Add padding around department (20%)
          const lonPadding = (deptBounds.maxLon - deptBounds.minLon) * 0.2;
          const latPadding = (deptBounds.maxLat - deptBounds.minLat) * 0.2;
          const zoomedBounds = {
            minLon: deptBounds.minLon - lonPadding,
            maxLon: deptBounds.maxLon + lonPadding,
            minLat: deptBounds.minLat - latPadding,
            maxLat: deptBounds.maxLat + latPadding
          };

          return (
            <div className="department-overlay" onClick={onClose}>
              <div className="department-map-full" onClick={(e) => e.stopPropagation()}>
                {/* Header with close button */}
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h2 className="text-4xl font-bold text-gray-800">
                      {department.name}
                    </h2>
                    <p className="text-lg text-gray-500 mt-1">{code} · {allAvailableCities.length} villes disponibles</p>
                  </div>
                  <button
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 text-5xl font-light leading-none transition-colors"
                  >
                    ×
                  </button>
                </div>

                {/* Search bar */}
                <div className="mb-4">
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    placeholder="Rechercher une ville..."
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                    onClick={(e) => e.stopPropagation()}
                  />
                  {searchTerm && (
                    <p className="text-sm text-gray-500 mt-2">
                      {filteredCities.length} ville{filteredCities.length !== 1 ? 's' : ''} trouvée{filteredCities.length !== 1 ? 's' : ''}
                    </p>
                  )}
                </div>

                {/* Department map */}
                <div className="flex-1 relative bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 shadow-inner" style={{ minHeight: '400px' }}>
                    {(() => {
                      // Calculate SVG coordinates of the department
                      const projectPoint = ([lon, lat]) => {
                        const x = ((lon - zoomedBounds.minLon) / (zoomedBounds.maxLon - zoomedBounds.minLon)) * 1000;
                        const y = ((zoomedBounds.maxLat - lat) / (zoomedBounds.maxLat - zoomedBounds.minLat)) * 1100;
                        return [x, y];
                      };

                      // Get all coordinates to find SVG bounding box
                      let minX = Infinity, maxX = -Infinity;
                      let minY = Infinity, maxY = -Infinity;

                      const processCoords = (coords) => {
                        if (Array.isArray(coords[0])) {
                          coords.forEach(processCoords);
                        } else {
                          const [x, y] = projectPoint(coords);
                          minX = Math.min(minX, x);
                          maxX = Math.max(maxX, x);
                          minY = Math.min(minY, y);
                          maxY = Math.max(maxY, y);
                        }
                      };

                      processCoords(departmentFeature.geometry.coordinates);

                      // Add padding
                      const padding = 50;
                      const viewBoxX = minX - padding;
                      const viewBoxY = minY - padding;
                      const viewBoxWidth = (maxX - minX) + (padding * 2);
                      const viewBoxHeight = (maxY - minY) + (padding * 2);
                      const viewBox = `${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}`;

                      const path = convertToSVGPath(departmentFeature.geometry.coordinates, zoomedBounds);

                      return (
                        <svg viewBox={viewBox} className="w-full h-full" preserveAspectRatio="xMidYMid meet">
                          <defs>
                            {/* Gradient for city markers */}
                            <radialGradient id="cityGradient">
                              <stop offset="0%" stopColor="#ef4444" />
                              <stop offset="100%" stopColor="#dc2626" />
                            </radialGradient>
                            {/* Glow effect */}
                            <filter id="glow">
                              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                              <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                              </feMerge>
                            </filter>
                          </defs>

                          {/* Department shape */}
                          <path
                            d={path}
                            fill={getDepartmentColor(code, state)}
                            stroke="#1f2937"
                            strokeWidth="5"
                            opacity="0.95"
                          />

                          {/* City markers */}
                          {(() => {
                            // Calculate positions with collision detection
                            const cityPositions = filteredCities.map((city) => {
                              const [lon, lat] = CITY_COORDINATES[city];
                              const [x, y] = projectPoint([lon, lat]);
                              return { city, x, y, visitLevel: getCityVisitLevel(city) };
                            });

                            // Anti-collision algorithm: separate overlapping markers
                            const minDistance = 40; // Minimum distance between markers
                            const adjustedPositions = [];

                            for (let i = 0; i < cityPositions.length; i++) {
                              const pos = cityPositions[i];
                              let { x, y } = pos;
                              let attempts = 0;
                              const maxAttempts = 10;

                              // Check collision with previously placed cities
                              while (attempts < maxAttempts) {
                                let hasCollision = false;

                                for (let j = 0; j < adjustedPositions.length; j++) {
                                  const other = adjustedPositions[j];
                                  const dx = x - other.x;
                                  const dy = y - other.y;
                                  const distance = Math.sqrt(dx * dx + dy * dy);

                                  if (distance < minDistance) {
                                    // Push away from collision
                                    const angle = Math.atan2(dy, dx);
                                    const pushDistance = (minDistance - distance) / 2;
                                    x += Math.cos(angle) * pushDistance;
                                    y += Math.sin(angle) * pushDistance;
                                    hasCollision = true;
                                  }
                                }

                                if (!hasCollision) break;
                                attempts++;
                              }

                              adjustedPositions.push({ ...pos, x, y });
                            }

                            return adjustedPositions.map(({ city, x, y, visitLevel }) => {
                              const levelColor = VISIT_LEVELS[visitLevel].color;
                              const isSelected = selectedCity === city;

                              return (
                                <g key={city} style={{ cursor: 'pointer' }} onClick={() => handleCityClick(city)}>
                                  {/* City marker */}
                                  <circle
                                    cx={x}
                                    cy={y}
                                    r={isSelected ? "20" : "16"}
                                    fill={levelColor}
                                    stroke={isSelected ? "#000" : "#fff"}
                                    strokeWidth={isSelected ? "6" : "4"}
                                    opacity="0.95"
                                    style={{ transition: 'all 0.3s ease' }}
                                  />
                                  {/* City name - only show if less than 15 cities or search is active */}
                                  {(filteredCities.length <= 15 || searchTerm) && (
                                    <text
                                      x={x}
                                      y={y + 35}
                                      textAnchor="middle"
                                      className="city-label"
                                    >
                                      {city}
                                    </text>
                                  )}
                                  {/* Show title for all cities */}
                                  <title>{city} - {VISIT_LEVELS[visitLevel].label}</title>
                                </g>
                              );
                            });
                          })()}
                        </svg>
                      );
                    })()}
                  </div>

                  {/* Visit level selector - minimalist */}
                  {selectedCity && (
                    <div className="mt-4 p-3 bg-white rounded-xl shadow-lg border-2 border-gray-300">
                      <p className="text-sm font-semibold text-gray-700 mb-2 text-center">
                        {selectedCity}
                      </p>
                      <div className="flex items-center justify-center gap-3">
                        {Object.entries(VISIT_LEVELS).map(([level, { color }]) => (
                          <button
                            key={level}
                            onClick={() => handleSetVisitLevel(selectedCity, level)}
                            className={`w-10 h-10 rounded-full border-4 transition-all ${
                              getCityVisitLevel(selectedCity) === level
                                ? 'border-gray-800 scale-110'
                                : 'border-white hover:scale-105'
                            }`}
                            style={{ backgroundColor: color }}
                            title={VISIT_LEVELS[level].label}
                          />
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Close hint */}
                  <p className="text-center text-gray-500 mt-4 text-sm">
                    Cliquez n'importe où pour revenir à la carte
                  </p>
                </div>
              </div>
          );
        }

        function DepartmentModal({ code, department, state, onClose, onUpdate, geoData, bounds, convertToSVGPath, getDepartmentColor }) {
          const [visitLevel, setVisitLevel] = useState(state.visitLevel);
          const [visitedCities, setVisitedCities] = useState(state.visitedCities);
          const [customCities, setCustomCities] = useState(state.customCities);
          const [notes, setNotes] = useState(state.notes);
          const [newCity, setNewCity] = useState('');
          const [rating, setRating] = useState(state.rating || 0);

          const toggleCity = (city) => {
            setVisitedCities(prev =>
              prev.includes(city) ? prev.filter(c => c !== city) : [...prev, city]
            );
          };

          const addCity = () => {
            if (newCity.trim() && !customCities.includes(newCity.trim())) {
              setCustomCities(prev => [...prev, newCity.trim()]);
              setNewCity('');
            }
          };

          const handleSave = () => {
            onUpdate({
              visitLevel,
              visitedCities,
              customCities,
              notes,
              rating
            });
            onClose();
          };

          const allCities = [...department.cities, ...customCities];

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto" onClick={onClose}>
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl my-8" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-center p-6 border-b sticky top-0 bg-white rounded-t-2xl z-10">
                  <h2 className="text-2xl font-bold text-gray-800">
                    {department.name} ({code})
                  </h2>
                  <button
                    onClick={onClose}
                    className="text-gray-400 hover:text-gray-600 text-3xl font-bold leading-none"
                  >
                    ×
                  </button>
                </div>

                <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                  {/* Department Map */}
                  {geoData && bounds && (
                    <div className="bg-gray-100 rounded-lg p-4">
                      <h3 className="font-semibold text-gray-700 mb-3 text-lg">Carte du département</h3>
                      <div className="bg-white rounded-lg p-4 shadow-inner">
                        <svg viewBox="0 0 1000 1100" className="w-full h-auto" style={{ maxHeight: '300px' }}>
                          {/* Department shape */}
                          {geoData.features
                            .filter(feature => feature.properties.code === code)
                            .map(feature => {
                              const path = convertToSVGPath(feature.geometry.coordinates, bounds);
                              return (
                                <path
                                  key={code}
                                  d={path}
                                  fill={getDepartmentColor(code, state)}
                                  stroke="#333"
                                  strokeWidth="3"
                                  opacity="0.7"
                                />
                              );
                            })}

                          {/* City markers */}
                          {visitedCities.map(city => {
                            if (!CITY_COORDINATES[city]) return null;
                            const [lon, lat] = CITY_COORDINATES[city];
                            const cityX = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * 1000;
                            const cityY = ((bounds.maxLat - lat) / (bounds.maxLat - bounds.minLat)) * 1100;

                            return (
                              <g key={city}>
                                <circle
                                  cx={cityX}
                                  cy={cityY}
                                  r="8"
                                  fill="#e74c3c"
                                  stroke="#fff"
                                  strokeWidth="3"
                                />
                                <title>{city}</title>
                              </g>
                            );
                          })}
                        </svg>
                      </div>
                    </div>
                  )}

                  {/* Rating */}
                  <div>
                    <label className="block font-semibold text-gray-700 mb-3 text-lg">
                      Note {rating > 0 && <span className="text-gray-600">({rating}/5)</span>}
                    </label>
                    <div className="flex items-center gap-2">
                      {[1, 2, 3, 4, 5].map(star => (
                        <button
                          key={star}
                          onClick={() => setRating(star === rating ? 0 : star)}
                          className="text-4xl transition-all hover:scale-110"
                        >
                          {star <= rating ? '⭐' : '☆'}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Visit Level */}
                  <div>
                    <label className="block font-semibold text-gray-700 mb-3 text-lg">Niveau de visite</label>
                    <div className="grid grid-cols-2 gap-3">
                      {Object.entries(VISIT_LEVELS).map(([key, { label }]) => (
                        <button
                          key={key}
                          onClick={() => setVisitLevel(key)}
                          className={`p-3 rounded-lg border-2 font-medium transition-all ${
                            visitLevel === key
                              ? 'bg-blue-500 text-white border-blue-500'
                              : 'bg-white text-gray-700 border-gray-300 hover:border-blue-300'
                          }`}
                        >
                          {label}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Cities */}
                  <div>
                    <h3 className="font-semibold text-gray-700 mb-3 text-lg">Villes visitées</h3>
                    <div className="flex flex-wrap gap-2 mb-4">
                      {allCities.map(city => (
                        <button
                          key={city}
                          onClick={() => toggleCity(city)}
                          className={`px-4 py-2 rounded-full transition-all flex items-center gap-2 ${
                            visitedCities.includes(city)
                              ? 'bg-blue-500 text-white'
                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          {visitedCities.includes(city) && <span className="font-bold">✓</span>}
                          <span>{city}</span>
                        </button>
                      ))}
                    </div>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={newCity}
                        onChange={(e) => setNewCity(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && addCity()}
                        placeholder="Ajouter une ville..."
                        className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                      />
                      <button
                        onClick={addCity}
                        className="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600"
                      >
                        +
                      </button>
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block font-semibold text-gray-700 mb-3 text-lg">Notes de voyage 📝</label>
                    <textarea
                      value={notes}
                      onChange={(e) => setNotes(e.target.value)}
                      placeholder="Ajoutez vos souvenirs, anecdotes, recommandations..."
                      className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                      rows={5}
                    />
                  </div>

                  <button
                    onClick={handleSave}
                    className="w-full py-4 bg-blue-500 text-white font-bold text-lg rounded-lg hover:bg-blue-600 transition-colors"
                  >
                    💾 Enregistrer
                  </button>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<FranceMap />, document.getElementById('root'));
    </script>
</body>
</html>
